---
title: "Differential expression analysis"
author:
  # - Jane Doe^[Institution Two, jane@example.org]      # add report authors (uncomment if using)
  # - John Doe^[Institution One, john@example.org]      # add a second report author (uncomment if using)
date: "Date: `r base::format(Sys.time(), '%d/%m/%Y')`"
always_allow_html: true
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: false
    self_contained: yes
    css: ../esr-styles.css
    highlight: pygments
    includes:
      after_body: ../esr_footer.html
  editor_options: 
    chunk_output_type: console
---

<img src="../images/ESR_logo.svg" style="position:absolute;top:19px;right:40px;width:23%;" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.align = "center")
```

```{bash}
# create a directory to write data to file (if it doesn't yet exist)
mkdir -p diff_expr_results/
```

## Info

General info:

- Two methods were employed to undertake a differential expression analysis, namely [limma/voom](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2014-15-2-r29) and [deseq2](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0550-8).
- Some values have been rounded

```{r, data_prep, results = "hide"}
# load libraries
library(dplyr)
library(limma)
library(DESeq2)
library(janitor)
library(edgeR)
library(DT)
library(apeglm)
library(plotly)
library(heatmaply)
library(gtools)
library(textshape)
library(tidyr)

# for icons at bottom of doc
htmltools::tagList(rmarkdown::html_dependency_font_awesome())

# read in yaml config file
config <- yaml::yaml.load_file("../config/config.yaml")

# read in metadata
metadata <- utils::read.csv(base::file.path(config$metadata))

# create a list defining which code chunks to analyse (that are set to TRUE for both the datasets and contrasts to analyse) based on the yaml user configuration file
to_eval_chunk <- config[c("mirna_smrnaseq",
                          "mirna_excerpt",
                          "pirna_excerpt",
                          "trna_excerpt",
                          "circrna_excerpt",
                          "gencode_excerpt")] %>%
  rep(times = 6)

names(to_eval_chunk)[1:6] <- paste(names(to_eval_chunk)[1:6], "1", sep = "_")
names(to_eval_chunk)[7:12] <- paste(names(to_eval_chunk)[7:12], "2", sep = "_")
names(to_eval_chunk)[13:18] <- paste(names(to_eval_chunk)[13:18], "3", sep = "_")
names(to_eval_chunk)[19:24] <- paste(names(to_eval_chunk)[19:24], "4", sep = "_")
names(to_eval_chunk)[25:30] <- paste(names(to_eval_chunk)[25:30], "5", sep = "_")
names(to_eval_chunk)[31:36] <- paste(names(to_eval_chunk)[31:36], "6", sep = "_")

n_contrasts <- base::length(config$contrasts)

to_eval_chunk <- if(n_contrasts == 1) {
  replace(to_eval_chunk, 7:36, FALSE)
} else if(n_contrasts == 2) {
  replace(to_eval_chunk, 13:36, FALSE)
} else if(n_contrasts == 3) {
  replace(to_eval_chunk, 19:36, FALSE)
} else if(n_contrasts == 4) {
  replace(to_eval_chunk, 25:36, FALSE)
} else if(n_contrasts == 5) {
  replace(to_eval_chunk, 31:36, FALSE)
} else if(n_contrasts == 6) {
  to_eval_chunk
}

# create a list defining which code chunks to analyse (based on the number of contrasts to analyse) based on the yaml user configuration file
contrasts_chunk_eval <- list(contrast_1 = TRUE,
                             contrast_2 = TRUE,
                             contrast_3 = TRUE,
                             contrast_4 = TRUE,
                             contrast_5 = TRUE,
                             contrast_6 = TRUE)

contrasts_chunk_eval <- if(n_contrasts == 1) {
  replace(contrasts_chunk_eval, 2:6, FALSE)
} else if(n_contrasts == 2) {
  replace(contrasts_chunk_eval, 3:6, FALSE)
} else if(n_contrasts == 3) {
  replace(contrasts_chunk_eval, 4:6, FALSE)
} else if(n_contrasts == 4) {
  replace(contrasts_chunk_eval, 5:6, FALSE)
} else if(n_contrasts == 5) {
  replace(contrasts_chunk_eval, 6, FALSE)
} else if(n_contrasts == 6) {
  contrasts_chunk_eval
}

# read in mapping rates info
mapping_rates <- utils::read.csv("../mapping_rates/mapping_rates.csv")

# tidy up sample names
mapping_rates$sample <- base::gsub('(_*)_\\w+', '', mapping_rates$sample)

# remove empty rows
mapping_rates <- mapping_rates %>%
  tidyr::drop_na()

# evalutate/setup minimum logFC threshold
min_logfc <- base::eval(base::parse(text = config$min_lfc))

# set up a flag for when the sequencing read counts for a sample is low (defined by the user in the config file)
low_read_count_flag <- mapping_rates %>%
  dplyr::filter(raw_read_count_fastq_file < config$low_sequencing_read_count) %>%
  dplyr::group_by(sample) %>%
  dplyr::summarise() %>%
  dplyr::pull(sample)

# make a TRUE/FALSE list that defines how many contrasts were analysed
# a vector of up to 6 elements since this is the max number of contrasts I've accounted for in this document
# will be used to conditionally include code chunks depending on how many contrasts/comparisons the user has chosen to analyse
contrasts <- base::append(config$contrasts, rep.int(FALSE, times = 6))
contrasts <- contrasts[1:6]
contrasts[contrasts != FALSE] <- TRUE
contrasts <- base::as.logical(contrasts)

# specify treatments by creating a string of conditions that match the order of the columns/samples in the count data
# get the treatments and samples names from the metadata file
treatments <- metadata %>%
  dplyr::select(sample, treatment)

# also sort by the sample column (important so it matches the order of the samples count datasets)
# this is critical for DESeq2 - it assumes they are in the same order
treatments <- treatments[gtools::mixedorder(base::as.character(treatments$sample)),]

# extract only the conditions/groups and create a list out of it
ordered_treatments <- treatments %>%
  dplyr::pull(treatment)
```

```{r, eval = config$mirna_smrnaseq}
# load count dataset (premade rds objects)
raw_mirna_smrnaseq_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_mirna_smrnaseq_counts.rds"))
```

```{r, eval = config$mirna_excerpt}
# load count dataset (premade rds objects)
raw_mirna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_mirna_excerpt_counts.rds"))
```

```{r, eval = config$pirna_excerpt}
# load count dataset (premade rds objects)
raw_pirna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_pirna_excerpt_counts.rds"))
```

```{r, eval = config$trna_excerpt}
# load count dataset (premade rds objects)
raw_trna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_trna_excerpt_counts.rds"))
```

```{r, eval = config$circrna_excerpt}
# load count dataset (premade rds objects)
raw_circrna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_circrna_excerpt_counts.rds"))
```

```{r, eval = config$gencode_excerpt}
# load count dataset (premade rds objects)
raw_gencode_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_gencode_excerpt_counts.rds"))
```

```{r}
# make a list of all the count datasets in the global environment
count_datasets <- base::do.call("list", base::mget(base::grep("_data", base::names(.GlobalEnv), value=TRUE)))

# make sure the samples (columns) in all the datasets are in the same order for specifying the treatments downstream
# (that depends on the columns being in the correct order)  (loop over all count datasets)
count_datasets <- base::lapply(count_datasets, function(x) {
  
  x[ , gtools::mixedsort(names(x))]
  
})

# convert datasets to matrices (loop over all count datasets)
# also round read counts to the nearest integer to avoid a downstream error with DESeqDataSetFromMatrix() (see this discussion https://www.biostars.org/p/368158/)
count_datasets <- base::lapply(count_datasets, function(x) {
  
  x %>%
    base::round() %>%
    base::as.matrix(sep = "\t", row.names = "rna_id")
  
})

# setup a function to plot residual variances
# (code adapted from the "limma::plotSA()" function to make interactive and add more info like which RNA each point is)
plotSA_interactive <- function(data) {
  
  # get data from voom fit
  x <- data$Amean
  y <- base::sqrt(data$sigma)
  
  if (!(base::is.null(data$weights) || zero.weights)) {
    allzero <- base::rowSums(data$weights > 0, na.rm = TRUE) == 
      0
    y[allzero] <- NA
  }
  
  if (base::length(data$df.prior) > 1L) {
    df2 <- base::max(data$df.prior)
    s2 <- data$sigma^2/fit$s2.prior
    pdn <- stats::pf(s2, df1 = data$df.residual, df2 = df2)
    pup <- stats::pf(s2, df1 = data$df.residual, df2 = df2, lower.tail = FALSE)
    FDR <- stats::p.adjust(2 * pmin(pdn, pup), method = "BH")
    colv[FDR <= 0.5] <- col[2]
  }
  
  # make into a dataframe for plotting, also get the RNA info
  plotting_data <- base::cbind(x, y) %>%
    base::as.data.frame() %>%
    tibble::rownames_to_column("rna")
  
  # shorten the RNA names for plotting
  plotting_data$rna <- base::gsub("\\|.*", " etc.", plotting_data$rna)
  
  # calculate horizontal line
  h <- base::sqrt(base::sqrt(data$s2.prior))
  
  # set up function to draw horizontal line
  hline <- function(y = 0, color = "black") {
    base::list(
      type = "line", 
      x0 = 0, 
      x1 = 1, 
      xref = "paper",
      y0 = y, 
      y1 = y, 
      line = base::list(color = color)
    )
  }
  
  # plot
  plotting_data %>%
    plotly::plot_ly(x = ~x,
                    y = ~y,
                    marker = list(color = "#0097db", opacity = 0.7),
                    hoverinfo = "text",
                    text = ~ base::paste("</br> Average log expression:", base::format(x, big.mark = ",", scientific = FALSE, digits = 3),
                                         "</br> sqrt(sigma):", base::format(y, big.mark = ",", scientific = FALSE, digits = 4),
                                         "</br> RNA:", rna),
                    showlegend = FALSE) %>%
    plotly::layout(shapes = base::list(hline(h))) %>%
    plotly::layout(xaxis = base::list(title = "Average log expression"),
                   yaxis = base::list(title = "sqrt(sigma)"))
}

# setup a function to plot volcano plots
volcano_interactive <- function(data_frame) {
  
  # add all points in blue
  plotly::plot_ly(data = data_frame,
                  x = ~log_fc,
                  y = ~adj_p_value,
                  type = "scatter",
                  marker = list(color = "#0097db", opacity = 0.7),
                  hoverinfo = "text",
                  text = ~paste(" RNA:", rna,
                                "</br></br>",
                                "p-value: ", base::round(p_value, digits = 10),
                                "</br>",
                                "adjusted p-value: ", base::round(adj_p_value, digits = 10),
                                "</br>",
                                "-log10 adjusted p-value: ", base::round(adj_p_value, digits = 10),
                                "</br>",
                                "Log fold change:", base::round(log_fc, digits = 4)),
                  showlegend = FALSE) %>%
    
    # add significant points in red
    add_trace(data = dplyr::filter(data_frame, (adj_p_value <= 0.1) & ((log_fc >= min_logfc) | (log_fc <= -min_logfc))),
              x = ~log_fc,
              y = ~adj_p_value,
              type = "scatter",
              marker = list(color = "#ec1515", opacity = 0.7)) %>%
    
    # add significant points in yellow
    add_trace(data = dplyr::filter(data_frame, (adj_p_value <= 0.05) & ((log_fc >= min_logfc) | (log_fc <= -min_logfc))),
              x = ~log_fc,
              y = ~adj_p_value,
              type = "scatter",
              marker = list(color = "#febf2a", opacity = 0.7)) %>%
    
    # add significant points in green
    add_trace(data = dplyr::filter(data_frame, (adj_p_value <= 0.01) & ((log_fc >= min_logfc) | (log_fc <= -min_logfc))),
              x = ~log_fc,
              y = ~adj_p_value,
              type = "scatter",
              marker = list(color = "#85C659", opacity = 0.7)) %>%
    
    # formatting
    plotly::layout(xaxis = base::list(title = "Log fold change"),
                   yaxis = base::list(title = "-log10 adjusted p-value",
                                      type = "log",
                                      autorange = "reversed"))
}

# setup a function to plot MA plots
MA_interactive <- function(data_frame) {
  
  # plot
  plotly::plot_ly(data = data_frame,
                  x = ~ baseMean,
                  y = ~ log_fc,
                  type = "scatter",
                  marker = list(color = "#0097db", opacity = 0.7),
                  hoverinfo = "text",
                  text = ~ base::paste(" RNA:", rna,
                                       "</br></br>",
                                       "Mean of normalized counts:", base::round(baseMean, digits = 0),
                                       "</br>",
                                       "Log fold change:", base::round(log_fc, digits = 4),
                                       "</br>",
                                       "Adjusted p-value:", base::round(adj_p_value, digits = 10)),
                  showlegend = FALSE) %>%
    
    # add significant points in red
    add_trace(data = dplyr::filter(data_frame, (adj_p_value <= 0.1) & ((log_fc >= min_logfc) | (log_fc <= -min_logfc))),
              x = ~ baseMean,
              y = ~ log_fc,
              type = "scatter",
              marker = list(color = "#ec1515", opacity = 0.7)) %>%
    
    # add significant points in yellow
    add_trace(data = dplyr::filter(data_frame, (adj_p_value <= 0.05) & ((log_fc >= min_logfc) | (log_fc <= -min_logfc))),
              x = ~ baseMean,
              y = ~ log_fc,
              type = "scatter",
              marker = list(color = "#febf2a", opacity = 0.7)) %>%
    
    # add significant points in green
    add_trace(data = dplyr::filter(data_frame, (adj_p_value <= 0.01) & ((log_fc >= min_logfc) | (log_fc <= -min_logfc))),
              x = ~ baseMean,
              y = ~ log_fc,
              type = "scatter",
              marker = list(color = "#85C659", opacity = 0.7)) %>%
    
    # formatting
    plotly::layout(xaxis = base::list(title = "Mean of normalized counts",
                                      type = "log"),
                   yaxis = base::list(title = "Log fold change"))
}
```

Treatment comparisons: 

```{r, results = "asis"}
# print the treatment group comparisons the user has chosen to analyse
base::cat(base::paste0("- ", config$contrasts, "\n"))
```

```{r, results = "asis"}
# print the number of samples analysed
base::cat(base::paste0("Total number of samples: ", base::length(base::unique(metadata$sample))))
```

Number of samples in each treatment group:

```{r, results = "asis"}
# print the number of samples in each treatment group
n_samples_by_treatment <- metadata %>%
  group_by(treatment) %>%
  dplyr::summarise(n_samples = n())

base::cat(base::paste0("- ", n_samples_by_treatment$treatment, ": ", n_samples_by_treatment$n_samples, "\n"))
```

## limma/voom

```{r, results = "asis"}
base::cat(base::paste0("The data was filtered using the [filterByExpr](https://rdrr.io/bioc/edgeR/man/filterByExpr.html) function. The filtering keeps RNA's that have count-per-million (CPM) above min.count (", config$min_count, ")", " in n samples (", base::length(base::unique(metadata$sample)), "). In addition, each kept RNA is required to have at least min.total.count reads (", config$min_total_count, ") across all the samples. From a statistical point of view, removing low count RNA's allows the mean-variance relationship in the data to be estimated with greater reliability ([Law et al., (2018)](https://f1000research.com/articles/5-1408))."))
```

```{r, results = "asis"}
base::cat(base::paste0("Normalization factors used to scale the raw library sizes are calculated using the [calcNormFactors](https://www.rdocumentation.org/packages/edgeR/versions/3.14.0/topics/calcNormFactors) function using the TMM normalization method. This method uses the weighted trimmed mean of M-values (to the reference) proposed by [Robinson and Oshlack (2010)](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2010-11-3-r25), where the weights are from the delta method on Binomial data. "))
```

```{r, results = "asis"}
base::cat(base::paste0("The count data is then transformed to log2-counts per million (logCPM) using the [voom](https://www.rdocumentation.org/packages/limma/versions/3.28.14/topics/voom) function (see the paper [here](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2014-15-2-r29)). Fitting linear models to the comparisons/contrasts (", base::toString(config$contrasts), ") is carried out using the [lmFit](https://www.rdocumentation.org/packages/limma/versions/3.28.14/topics/lmFit) and [contrasts.fit](https://www.rdocumentation.org/packages/limma/versions/3.28.14/topics/contrasts.fit) functions. Next, empirical Bayes moderation is carried using the [eBayes](https://www.rdocumentation.org/packages/limma/versions/3.28.14/topics/ebayes) function which borrows information across all RNA's to obtain more precise estimates of RNA-wise variability ([Law et al., (2018)](https://f1000research.com/articles/5-1408)). It computes moderated t-statistics, moderated F-statistic, and log-odds of differential expression by empirical Bayes moderation of the standard errors towards a common value."))
```

```{r, results = "asis"}
base::cat(base::paste0("The Benjamini and Hochberg method (see [Benjamini & Hochberg (1995)](https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1995.tb02031.x)) was used in the [topTreat function](https://www.rdocumentation.org/packages/limma/versions/3.28.14/topics/toptable) to adjust the p-values to account for multiple testing, reducing the false discovery rate. See [this article comparing the different adjustment methods](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6099145/). Both the limma/voom and DESeq2 differential expression methods use the same p-value adjustment method."))
```

```{r, limma_voom}
# create DGEList objects for the datasets (loop over all count datasets)
dge <- base::lapply(count_datasets, function(x) {
  
  edgeR::DGEList(counts = x, group = ordered_treatments)
  
})

# filter lowly expressed RNA
keep <- base::lapply(dge, function(x) {
  
  edgeR::filterByExpr(x, group=ordered_treatments, min.count = config$min_count, min.total.count = config$min_total_count)
  
})
```

```{r, eval = config$mirna_smrnaseq}
# filtering and calulating normalisation factors (I couldn't get this to work in a list of datasets)
# (note. calcNormFactors doesn’t normalize the data, it just calculates normalization factors for use downstream)
dge_mirna_smrnaseq_filtered <- dge$raw_mirna_smrnaseq_data[keep$raw_mirna_smrnaseq_data,, keep.lib.sizes=FALSE] %>%
  edgeR::calcNormFactors(method="TMM")
```

```{r, eval = config$mirna_excerpt}
# filtering and calulating normalisation factors (I couldn't get this to work in a list of datasets)
# (note. calcNormFactors doesn’t normalize the data, it just calculates normalization factors for use downstream)
dge_mirna_excerpt_filtered <- dge$raw_mirna_excerpt_data[keep$raw_mirna_excerpt_data,, keep.lib.sizes=FALSE] %>%
  edgeR::calcNormFactors(method="TMM")
```

```{r, eval = config$pirna_excerpt}
# filtering and calulating normalisation factors (I couldn't get this to work in a list of datasets)
# (note. calcNormFactors doesn’t normalize the data, it just calculates normalization factors for use downstream)
dge_pirna_excerpt_filtered <- dge$raw_pirna_excerpt_data[keep$raw_pirna_excerpt_data,, keep.lib.sizes=FALSE] %>%
  edgeR::calcNormFactors(method="TMM")
```

```{r, eval = config$trna_excerpt}
# filtering and calulating normalisation factors (I couldn't get this to work in a list of datasets)
# (note. calcNormFactors doesn’t normalize the data, it just calculates normalization factors for use downstream)
dge_trna_excerpt_filtered <- dge$raw_trna_excerpt_data[keep$raw_trna_excerpt_data,, keep.lib.sizes=FALSE] %>%
  edgeR::calcNormFactors(method="TMM")
```

```{r, eval = config$circrna_excerpt}
# filtering and calulating normalisation factors (I couldn't get this to work in a list of datasets)
# (note. calcNormFactors doesn’t normalize the data, it just calculates normalization factors for use downstream)
dge_circrna_excerpt_filtered <- dge$raw_circrna_excerpt_data[keep$raw_circrna_excerpt_data,, keep.lib.sizes=FALSE] %>%
  edgeR::calcNormFactors(method="TMM")
```

```{r, eval = config$gencode_excerpt}
# filtering and calulating normalisation factors (I couldn't get this to work in a list of datasets)
# (note. calcNormFactors doesn’t normalize the data, it just calculates normalization factors for use downstream)
dge_gencode_excerpt_filtered <- dge$raw_gencode_excerpt_data[keep$raw_gencode_excerpt_data,, keep.lib.sizes=FALSE] %>%
  edgeR::calcNormFactors(method="TMM")
```

```{r}
# create a model matrix
# also simplify the column names in the model matrix (loop over all count datasets)
model_matrix <- base::lapply(dge, function(x) {
  
  stats::model.matrix(~0+ordered_treatments) %>%
    base::as.data.frame() %>%
    dplyr::rename_with(~ (base::gsub("ordered_treatments", "", .x, fixed = TRUE))) %>%
    base::data.matrix()
  
})

# specify which groups to compare (based on the users choice of contrasts to compare) (loop over all count datasets)
contr_matrix <- base::lapply(model_matrix, function(x) {
  
  limma::makeContrasts(contrasts = c(config$contrasts), levels = base::colnames(x))
  
})
```

### Mean variance plot {.tabset .tabset-fade}

The mean-variance relationship of log-CPM values for this dataset. Typically, the “voom-plot” shows a decreasing trend between the means and variances resulting from a combination of technical variation in the sequencing experiment and biological variation amongst the replicate samples from different treatment groups. Experiments with high biological variation usually result in flatter trends, where variance values plateau at high expression values. Experiments with low biological variation tend to result in sharp decreasing trends ([Law et al., (2018)](https://f1000research.com/articles/5-1408)).

Moreover, the voom-plot provides a visual check on the level of filtering performed upstream. If filtering of lowly-expressed RNA's is insufficient, a drop in variance levels can be observed at the low end of the expression scale due to very small counts. If this is observed, one should return to the earlier filtering step and increase the expression threshold applied to the dataset ([Law et al., (2018)](https://f1000research.com/articles/5-1408)).

```{r, eval = config$mirna_smrnaseq, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (smrnaseq)")
```

```{r, eval = config$mirna_smrnaseq, out.width = "100%"}
# remove heteroscedascity from count data and plot mean variance
mirna_smrnaseq_limmavoom_v <- limma::voom(dge_mirna_smrnaseq_filtered,  model_matrix$raw_mirna_smrnaseq_data, plot=TRUE)
```

```{r, eval = config$mirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (excerpt)")
```

```{r, eval = config$mirna_excerpt, out.width = "100%"}
# remove heteroscedascity from count data and plot mean variance
mirna_excerpt_limmavoom_v <- limma::voom(dge_mirna_excerpt_filtered,  model_matrix$raw_mirna_excerpt_data, plot=TRUE)
```

```{r, eval = config$pirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### piRNA's (excerpt)")
```

```{r, eval = config$pirna_excerpt, out.width = "100%"}
# remove heteroscedascity from count data and plot mean variance
pirna_excerpt_limmavoom_v <- limma::voom(dge_pirna_excerpt_filtered,  model_matrix$raw_pirna_excerpt_data, plot=TRUE)
```

```{r, eval = config$trna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### tRNA's (excerpt)")
```

```{r, eval = config$trna_excerpt, out.width = "100%"}
# remove heteroscedascity from count data and plot mean variance
trna_excerpt_limmavoom_v <- limma::voom(dge_trna_excerpt_filtered,  model_matrix$raw_trna_excerpt_data, plot=TRUE)
```

```{r, eval = config$circrna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### circRNA's (excerpt)")
```

```{r, eval = config$circrna_excerpt, out.width = "100%"}
# remove heteroscedascity from count data and plot mean variance
circrna_excerpt_limmavoom_v <- limma::voom(dge_circrna_excerpt_filtered,  model_matrix$raw_circrna_excerpt_data, plot=TRUE)
```

```{r, eval = config$gencode_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### gencodes (excerpt)")
```

```{r, eval = config$gencode_excerpt, out.width = "100%"}
# remove heteroscedascity from count data and plot mean variance
gencode_excerpt_limmavoom_v <- limma::voom(dge_gencode_excerpt_filtered,  model_matrix$raw_gencode_excerpt_data, plot=TRUE)
```

### Residual variances {.tabset .tabset-fade}

An adapted version of the [plotSA](http://rstudio.esr.cri.nz:8787/s/dec5c0fe7569e683b7632/help/library/limma/html/plotSA.html) function was used to create this plot (made interactive and included individual RNA information for each data point), which can be used to check the mean-variance relationship of the expression data, after fitting a linear model.

```{r, eval = config$mirna_smrnaseq, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (smrnaseq)")
```

```{r, eval = config$mirna_smrnaseq, out.width = "100%"}
# fit model to the expression values for each RNA
mirna_smrnaseq_limmavoom_vfit <- limma::lmFit(mirna_smrnaseq_limmavoom_v, model_matrix$raw_mirna_smrnaseq_data)

# estimate contrast for each miRNA
mirna_smrnaseq_limmavoom_vfit <- limma::contrasts.fit(mirna_smrnaseq_limmavoom_vfit, contr_matrix$raw_mirna_smrnaseq_data)

# empirical Bayes moderation - obtain more precise estimates of miRNA-wise variability
mirna_smrnaseq_limmavoom_efit <- limma::eBayes(mirna_smrnaseq_limmavoom_vfit)

# plot residual variances (code adapted from the "limma::plotSA()" function)
plotSA_interactive(mirna_smrnaseq_limmavoom_efit)
```

```{r, eval = config$mirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (excerpt)")
```

```{r, eval = config$mirna_excerpt, out.width = "100%"}
# fit model to the expression values for each RNA
mirna_excerpt_limmavoom_vfit <- limma::lmFit(mirna_excerpt_limmavoom_v, model_matrix$raw_mirna_excerpt_data)

# estimate contrast for each miRNA
mirna_excerpt_limmavoom_vfit <- limma::contrasts.fit(mirna_excerpt_limmavoom_vfit, contr_matrix$raw_mirna_excerpt_data)

# empirical Bayes moderation - obtain more precise estimates of miRNA-wise variability
mirna_excerpt_limmavoom_efit <- limma::eBayes(mirna_excerpt_limmavoom_vfit)

# plot residual variances (code adapted from the "limma::plotSA()" function)
plotSA_interactive(mirna_excerpt_limmavoom_efit)
```

```{r, eval = config$pirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### piRNA's (excerpt)")
```

```{r, eval = config$pirna_excerpt, out.width = "100%"}
# fit model to the expression values for each RNA
pirna_excerpt_limmavoom_vfit <- limma::lmFit(pirna_excerpt_limmavoom_v, model_matrix$raw_pirna_excerpt_data)

# estimate contrast for each miRNA
pirna_excerpt_limmavoom_vfit <- limma::contrasts.fit(pirna_excerpt_limmavoom_vfit, contr_matrix$raw_pirna_excerpt_data)

# empirical Bayes moderation - obtain more precise estimates of miRNA-wise variability
pirna_excerpt_limmavoom_efit <- limma::eBayes(pirna_excerpt_limmavoom_vfit)

# plot residual variances (code adapted from the "limma::plotSA()" function)
plotSA_interactive(pirna_excerpt_limmavoom_efit)
```

```{r, eval = config$trna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### tRNA's (excerpt)")
```

```{r, eval = config$trna_excerpt, out.width = "100%"}
# fit model to the expression values for each RNA
trna_excerpt_limmavoom_vfit <- limma::lmFit(trna_excerpt_limmavoom_v, model_matrix$raw_trna_excerpt_data)

# estimate contrast for each miRNA
trna_excerpt_limmavoom_vfit <- limma::contrasts.fit(trna_excerpt_limmavoom_vfit, contr_matrix$raw_trna_excerpt_data)

# empirical Bayes moderation - obtain more precise estimates of miRNA-wise variability
trna_excerpt_limmavoom_efit <- limma::eBayes(trna_excerpt_limmavoom_vfit)

# plot residual variances (code adapted from the "limma::plotSA()" function)
plotSA_interactive(trna_excerpt_limmavoom_efit)
```

```{r, eval = config$circrna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### circRNA's (excerpt)")
```

```{r, eval = config$circrna_excerpt, out.width = "100%"}
# fit model to the expression values for each RNA
circrna_excerpt_limmavoom_vfit <- limma::lmFit(circrna_excerpt_limmavoom_v, model_matrix$raw_circrna_excerpt_data)

# estimate contrast for each miRNA
circrna_excerpt_limmavoom_vfit <- limma::contrasts.fit(circrna_excerpt_limmavoom_vfit, contr_matrix$raw_circrna_excerpt_data)

# empirical Bayes moderation - obtain more precise estimates of miRNA-wise variability
circrna_excerpt_limmavoom_efit <- limma::eBayes(circrna_excerpt_limmavoom_vfit)

# plot residual variances (code adapted from the "limma::plotSA()" function)
plotSA_interactive(circrna_excerpt_limmavoom_efit)
```

```{r, eval = config$gencode_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### gencodes (excerpt)")
```

```{r, eval = config$gencode_excerpt, out.width = "100%"}
# fit model to the expression values for each RNA
gencode_excerpt_limmavoom_vfit <- limma::lmFit(gencode_excerpt_limmavoom_v, model_matrix$raw_gencode_excerpt_data)

# estimate contrast for each miRNA
gencode_excerpt_limmavoom_vfit <- limma::contrasts.fit(gencode_excerpt_limmavoom_vfit, contr_matrix$raw_gencode_excerpt_data)

# empirical Bayes moderation - obtain more precise estimates of miRNA-wise variability
gencode_excerpt_limmavoom_efit <- limma::eBayes(gencode_excerpt_limmavoom_vfit)

# plot residual variances (code adapted from the "limma::plotSA()" function)
plotSA_interactive(gencode_excerpt_limmavoom_efit)
```

```{r}
# make a list of all the efit objects in the global environment
efit <- base::do.call("list", base::mget(base::grep("_efit", base::names(.GlobalEnv), value=TRUE)))
```

```{r, eval = contrasts[1]}
# extract the results of the limma/voom differential expression analysis (first contrast) (loop over all efit datasets)
limma_voom_results_1 <- base::lapply(efit, function(x) {
  
  x %>%
    limma::treat(lfc = min_logfc) %>%
    limma::topTreat(coef = 1,
                    n = Inf,
                    adjust.method = "BH") %>%
    tibble::rownames_to_column("rna")
  
})

# collapse the list of dataframes into one
limma_voom_results_1 <- base::do.call(rbind, limma_voom_results_1)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
limma_voom_results_1 <- limma_voom_results_1 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("_limmavoom_efit.*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("_.*", "", source)) %>%
  dplyr::mutate(pipeline = gsub(".*_", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[1]) %>%
  dplyr::mutate(diff_expr_method = "limma/voom") %>%
  select(-source)

# select only some columns we're interested in
limma_voom_results_1 <- limma_voom_results_1 %>%
  select(rna, P.Value, adj.P.Val, logFC, rna_species, pipeline, comparison, diff_expr_method)

# rename adjusted p-value column before join
limma_voom_results_1 <- limma_voom_results_1 %>%
  dplyr::rename(p_value = P.Value) %>%
  dplyr::rename(adj_p_value = adj.P.Val) %>%
  dplyr::rename(log_fc = logFC)
```

```{r, eval = contrasts[2]}
# extract the results of the limma/voom differential expression analysis (second contrast) (loop over all efit datasets)
limma_voom_results_2 <- base::lapply(efit, function(x) {
  
  x %>%
    limma::treat(lfc = min_logfc) %>%
    limma::topTreat(coef = 2,
                    n = Inf,
                    adjust.method = "BH") %>%
    tibble::rownames_to_column("rna")
  
})

# collapse the list of dataframes into one
limma_voom_results_2 <- base::do.call(rbind, limma_voom_results_2)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
limma_voom_results_2 <- limma_voom_results_2 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("_limmavoom_efit.*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("_.*", "", source)) %>%
  dplyr::mutate(pipeline = gsub(".*_", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[2]) %>%
  dplyr::mutate(diff_expr_method = "limma/voom") %>%
  select(-source)

# select only some columns we're interested in
limma_voom_results_2 <- limma_voom_results_2 %>%
  select(rna, P.Value, adj.P.Val, logFC, rna_species, pipeline, comparison, diff_expr_method)

# rename adjusted p-value column before join
limma_voom_results_2 <- limma_voom_results_2 %>%
  dplyr::rename(p_value = P.Value) %>%
  dplyr::rename(adj_p_value = adj.P.Val) %>%
  dplyr::rename(log_fc = logFC)
```

```{r, eval = contrasts[3]}
# extract the results of the limma/voom differential expression analysis (third contrast) (loop over all efit datasets)
limma_voom_results_3 <- base::lapply(efit, function(x) {
  
  x %>%
    limma::treat(lfc = min_logfc) %>%
    limma::topTreat(coef = 3,
                    n = Inf,
                    adjust.method = "BH") %>%
    tibble::rownames_to_column("rna")
  
})

# collapse the list of dataframes into one
limma_voom_results_3 <- base::do.call(rbind, limma_voom_results_3)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
limma_voom_results_3 <- limma_voom_results_3 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("_limmavoom_efit.*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("_.*", "", source)) %>%
  dplyr::mutate(pipeline = gsub(".*_", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[3]) %>%
  dplyr::mutate(diff_expr_method = "limma/voom") %>%
  select(-source)

# select only some columns we're interested in
limma_voom_results_3 <- limma_voom_results_3 %>%
  select(rna, P.Value, adj.P.Val, logFC, rna_species, pipeline, comparison, diff_expr_method)

# rename adjusted p-value column before join
limma_voom_results_3 <- limma_voom_results_3 %>%
  dplyr::rename(p_value = P.Value) %>%
  dplyr::rename(adj_p_value = adj.P.Val) %>%
  dplyr::rename(log_fc = logFC)
```

```{r, eval = contrasts[4]}
# extract the results of the limma/voom differential expression analysis (fourth contrast) (loop over all efit datasets)
limma_voom_results_4 <- base::lapply(efit, function(x) {
  
  x %>%
    limma::treat(lfc = min_logfc) %>%
    limma::topTreat(coef = 4,
                    n = Inf,
                    adjust.method = "BH") %>%
    tibble::rownames_to_column("rna")
  
})

# collapse the list of dataframes into one
limma_voom_results_4 <- base::do.call(rbind, limma_voom_results_4)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
limma_voom_results_4 <- limma_voom_results_4 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("_limmavoom_efit.*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("_.*", "", source)) %>%
  dplyr::mutate(pipeline = gsub(".*_", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[4]) %>%
  dplyr::mutate(diff_expr_method = "limma/voom") %>%
  select(-source)

# select only some columns we're interested in
limma_voom_results_4 <- limma_voom_results_4 %>%
  select(rna, P.Value, adj.P.Val, logFC, rna_species, pipeline, comparison, diff_expr_method)

# rename adjusted p-value column before join
limma_voom_results_4 <- limma_voom_results_4 %>%
  dplyr::rename(p_value = P.Value) %>%
  dplyr::rename(adj_p_value = adj.P.Val) %>%
  dplyr::rename(log_fc = logFC)
```

```{r, eval = contrasts[5]}
# extract the results of the limma/voom differential expression analysis (fifth contrast) (loop over all efit datasets)
limma_voom_results_5 <- base::lapply(efit, function(x) {
  
  x %>%
    limma::treat(lfc = min_logfc) %>%
    limma::topTreat(coef = 5,
                    n = Inf,
                    adjust.method = "BH") %>%
    tibble::rownames_to_column("rna")
  
})

# collapse the list of dataframes into one
limma_voom_results_5 <- base::do.call(rbind, limma_voom_results_5)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
limma_voom_results_5 <- limma_voom_results_5 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("_limmavoom_efit.*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("_.*", "", source)) %>%
  dplyr::mutate(pipeline = gsub(".*_", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[5]) %>%
  dplyr::mutate(diff_expr_method = "limma/voom") %>%
  select(-source)

# select only some columns we're interested in
limma_voom_results_5 <- limma_voom_results_5 %>%
  select(rna, P.Value, adj.P.Val, logFC, rna_species, pipeline, comparison, diff_expr_method)

# rename adjusted p-value column before join
limma_voom_results_5 <- limma_voom_results_5 %>%
  dplyr::rename(p_value = P.Value) %>%
  dplyr::rename(adj_p_value = adj.P.Val) %>%
  dplyr::rename(log_fc = logFC)
```

```{r, eval = contrasts[6]}
# extract the results of the limma/voom differential expression analysis (sixth contrast) (loop over all efit datasets)
limma_voom_results_6 <- base::lapply(efit, function(x) {
  
  x %>%
    limma::treat(lfc = min_logfc) %>%
    limma::topTreat(coef = 6,
                    n = Inf,
                    adjust.method = "BH") %>%
    tibble::rownames_to_column("rna")
  
})

# collapse the list of dataframes into one
limma_voom_results_6 <- base::do.call(rbind, limma_voom_results_6)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
limma_voom_results_6 <- limma_voom_results_6 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("_limmavoom_efit.*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("_.*", "", source)) %>%
  dplyr::mutate(pipeline = gsub(".*_", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[6]) %>%
  dplyr::mutate(diff_expr_method = "limma/voom") %>%
  select(-source)

# select only some columns we're interested in
limma_voom_results_6 <- limma_voom_results_6 %>%
  select(rna, P.Value, adj.P.Val, logFC, rna_species, pipeline, comparison, diff_expr_method)

# rename adjusted p-value column before join
limma_voom_results_6 <- limma_voom_results_6 %>%
  dplyr::rename(p_value = P.Value) %>%
  dplyr::rename(adj_p_value = adj.P.Val) %>%
  dplyr::rename(log_fc = logFC)
```

```{r}
# make a list of all the differential expression results objects in the global environment
limma_voom_diff_expr_results <- base::do.call("list", base::mget(base::grep("limma_voom_results_*", base::names(.GlobalEnv), value=TRUE)))

# collapse all the differential expression resultsresults from all the contrasts analysed
limma_voom_diff_expr_results  <- base::do.call(rbind, limma_voom_diff_expr_results)

# create a column that defines if an RNA is significant or not (at three significance levels and based on
# both limma/voom and deseq results). I ordered the case_when conditions from not significant to significant
# at the 1% level. This way, if an observation is true in several of these case_when categories, it'll be 
# marked with the smallest p-value category is fits into, sort of "rounded up" to the smallest p-value,
# because this case_when function seems to overwrite a value if it falls in a later case_when category
# This data will be used as a "flag" (using highlighting) in the downstream app to indicate a possibly
# significantly differentiated RNA the user of the app might want to investigate
limma_voom_diff_expr_results <- limma_voom_diff_expr_results %>%
  dplyr::mutate(significance = dplyr::case_when(adj_p_value > 0.10 ~ "greater_than_10%",
                                                (adj_p_value > 0.05) & (adj_p_value <= 0.10) ~ "significant_10%",
                                                (adj_p_value > 0.01) & (adj_p_value <= 0.05) ~ "significant_5%",
                                                (adj_p_value <= 0.01) ~ "significant_1%"))
```

### Volcano plots {.tabset .tabset-fade}

```{r, results = "asis"}
base::cat("These plots plot the negative log of the p-value against the log fold change. RNA's with a **p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc, " are plotted here.")
```

<div class="alert alert-custom-blue">

```{r, results = "asis"}
base::cat(base::paste0("Blue: RNA's with an **adjusted p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-red">

```{r, results = "asis"}
base::cat(base::paste0("Red: RNA's with an **adjusted p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-yellow">

```{r, results = "asis"}
base::cat(base::paste0("Yellow: RNA's with an **adjusted p-value** smaller than 0.05 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-green">

```{r, results = "asis"}
base::cat(base::paste0("Green: RNA's with an **adjusted p-value** smaller than 0.01 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

```{r, eval = contrasts_chunk_eval$contrast_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[1]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_1, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[1]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_1, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_1, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_1, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_1, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_1, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[2]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_2, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[2]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_2, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_2, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_2, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_2, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_2, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[3]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_3, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[3]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_3, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_3, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_3, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_3, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_3, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[4]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_4, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[4]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_4, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_4, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_4, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_4, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_4, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[5]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_5, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[5]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_5, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_5, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_5, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_5, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_5, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[6]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_6, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[6]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_6, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_6, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_6, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_6, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_6, out.width = "100%"}
limma_voom_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

### Results

```{r, results = "asis"}
base::cat(base::paste0("RNA's with a **p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc, " for the [limma/voom](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2014-15-2-r29) differential expression method are reported here."))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_1%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.01"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_5%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.05"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_10%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.10"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'greater_than_10%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.10"))
```

```{r, out.width = "100%"}
# create datatable to explore the data
DT::datatable(limma_voom_diff_expr_results %>%
                dplyr::filter(p_value <= 0.1) %>%
                dplyr::select(rna,
                              rna_species,
                              pipeline,
                              diff_expr_method,
                              comparison,
                              log_fc,
                              p_value,
                              adj_p_value,
                              significance) %>%
                dplyr::mutate(across(c(rna_species,
                                       pipeline,
                                       diff_expr_method,
                                       comparison,
                                       significance), base::as.factor)) %>%
                dplyr::mutate(across(c(log_fc,
                                       p_value,
                                       adj_p_value), base::as.double)) %>%
                dplyr::mutate(across(c(p_value,
                                       adj_p_value), ~base::round(.x, digits = 10))) %>%
                dplyr::mutate(across(c(log_fc), ~base::round(.x, digits = 4))),
              filter = "top",
              rownames = FALSE,
              colnames = c("RNA",
                           "RNA species",
                           "Pipeline",
                           "Differential expression method",
                           "Comparison",
                           "Log fold change",
                           "p-value",
                           "Adjusted p-value",
                           "Significance"),
              extensions = base::list("ColReorder" = NULL,
                                      "Buttons" = NULL,
                                      "FixedColumns" = base::list(leftColumns=1)),
              options = list(
                dom = "BRrltpi",
                autoWidth = TRUE,
                buttons =
                  list("copy",
                       list(extend = "collection",
                            buttons = c("csv", "excel", "pdf"),
                            text = "Download"),
                       I("colvis"))))
```

```{r}
# write differential expression results to file
limma_voom_diff_expr_results %>%
  utils::write.table(file = "./diff_expr_results/limma_voom_diff_expr_results.tsv", row.names=FALSE, sep="\t")
```

## DESeq2

```{r, results = "asis"}
base::cat(base::paste0("This differential expression method is undertaken using the [DESeq2](https://www.rdocumentation.org/packages/DESeq2/versions/1.12.3/topics/DESeq) function. This performs an analysis through estimation of size factors ([estimateSizeFactors function](https://www.rdocumentation.org/packages/DESeq2/versions/1.12.3/topics/estimateSizeFactors)), estimation of dispersion ([estimateDispersions function](https://www.rdocumentation.org/packages/DESeq2/versions/1.12.3/topics/estimateDispersions)) and Negative Binomial GLM fitting and Wald statistics ([nbinomWaldTest function](https://www.rdocumentation.org/packages/DESeq2/versions/1.12.3/topics/nbinomWaldTest))."))
```

```{r, results = "asis"}
base::cat(base::paste0("When obtaining dispersion estimates, a parametric fit type was used for fitting of dispersions to the mean intensity. This fits a dispersion-mean relation via a robust gamma-family GLM (see [McCarthy et al., (2012)](https://academic.oup.com/nar/article/40/10/4288/2411520))."))
```

```{r, results = "asis"}
base::cat(base::paste0("The Benjamini and Hochberg method (see [Benjamini & Hochberg (1995)](https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1995.tb02031.x)) was used in the [results function](https://www.rdocumentation.org/packages/DESeq2/versions/1.12.3/topics/results) to adjust the p-values to account for multiple testing, reducing the false discovery rate. See [this article comparing the different adjustment methods](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6099145/). Both the limma/voom and DESeq2 differential expression methods use the same p-value adjustment method."))
```

```{r, results = "asis"}
base::cat(base::paste0("Additionally, a log fold change threshold of ", config$min_lfc, " was used in the [results function](https://www.rdocumentation.org/packages/DESeq2/versions/1.12.3/topics/results)."))
```

```{r, deseq, results = "hide"}
# convert sample column to rownames since deseq seems to require this format
ordered_treatments <- treatments %>%
  tibble::remove_rownames() %>%
  tibble::column_to_rownames(var = "sample")

# create a DESeqDataSet object from my cleaned matrix and carry out deseq differential expression analysis (loop over all count datasets)
deseq <- base::lapply(count_datasets, function(x) {
  
  x %>%
    DESeq2::DESeqDataSetFromMatrix(colData = ordered_treatments,
                                   design = ~ treatment) %>%
    DESeq2::DESeq(fitType = "parametric")
  
})
```

```{r, eval = contrasts[1]}
# comparison/contrast 1
# extract the results of the deseq differential expression analysis (loop over all count datasets)
deseq_results_1 <- base::lapply(deseq, function(x) {
  
  x %>%
    DESeq2::results(contrast = c("treatment", base::sub(" - .*", "", config$contrasts[1]), base::sub(".* - ", "", config$contrasts[1])),
                    lfcThreshold = min_logfc,
                    pAdjustMethod = "BH")
  
})
```

```{r, eval = contrasts[2]}
# comparison/contrast 2
# extract the results of the deseq differential expression analysis (loop over all count datasets)
deseq_results_2 <- base::lapply(deseq, function(x) {
  
  x %>%
    DESeq2::results(contrast = c("treatment", base::sub(" - .*", "", config$contrasts[2]), base::sub(".* - ", "", config$contrasts[2])),
                    lfcThreshold = min_logfc,
                    pAdjustMethod = "BH")
  
})
```

```{r, eval = contrasts[3]}
# comparison/contrast 3
# extract the results of the deseq differential expression analysis (loop over all count datasets)
deseq_results_3 <- base::lapply(deseq, function(x) {
  
  x %>%
    DESeq2::results(contrast = c("treatment", base::sub(" - .*", "", config$contrasts[3]), base::sub(".* - ", "", config$contrasts[3])),
                    lfcThreshold = min_logfc,
                    pAdjustMethod = "BH",
                    alpha = 0.1)
  
})
```

```{r, eval = contrasts[4]}
# comparison/contrast 4
# extract the results of the deseq differential expression analysis (loop over all count datasets)
deseq_results_4 <- base::lapply(deseq, function(x) {
  
  x %>%
    DESeq2::results(contrast = c("treatment", base::sub(" - .*", "", config$contrasts[4]), base::sub(".* - ", "", config$contrasts[4])),
                    lfcThreshold = min_logfc,
                    pAdjustMethod = "BH")
  
})
```

```{r, eval = contrasts[5]}
# comparison/contrast 5
# extract the results of the deseq differential expression analysis (loop over all count datasets)
deseq_results_5 <- base::lapply(deseq, function(x) {
  
  x %>%
    DESeq2::results(contrast = c("treatment", base::sub(" - .*", "", config$contrasts[5]), base::sub(".* - ", "", config$contrasts[5])),
                    lfcThreshold = min_logfc,
                    pAdjustMethod = "BH")
  
})
```

```{r, eval = contrasts[6]}
# comparison/contrast 6
# extract the results of the deseq differential expression analysis (loop over all count datasets)
deseq_results_6 <- base::lapply(deseq, function(x) {
  
  x %>%
    DESeq2::results(contrast = c("treatment", base::sub(" - .*", "", config$contrasts[6]), base::sub(".* - ", "", config$contrasts[6])),
                    lfcThreshold = min_logfc,
                    pAdjustMethod = "BH")
  
})
```

### Count outlier detection {.tabset .tabset-fade}

DESeq2 relies on the negative binomial distribution to make estimates and perform statistical inference on differences. While the negative binomial is versatile in having a mean and dispersion parameter, extreme counts in individual samples might not fit well to the negative binomial. For this reason, we perform automatic detection of count outliers. We use Cook’s distance, which is a measure of how much the fitted coefficients would change if an individual sample were removed (Cook 1977). For more on the implementation of Cook’s distance see the manual page for the results function. Below we plot the maximum value of Cook’s distance for each row over the rank of the test statistic to justify its use as a filtering criterion (based on [DESeq2 vignette](https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#count-outlier-detection)).

```{r, eval = config$mirna_smrnaseq, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (smrnaseq)")
```

```{r, eval = config$mirna_smrnaseq, out.width = "100%"}
# plot
data <- deseq_results_1$raw_mirna_smrnaseq_data
W <- data$stat
maxCooks <- base::apply(SummarizedExperiment::assays(deseq$raw_mirna_smrnaseq_data)[["cooks"]], 1, base::max)
idx <- !is.na(W)
base::plot(rank(W[idx]), maxCooks[idx], xlab = "rank of Wald statistic", 
           ylab = "maximum Cook's distance per RNA",
           ylim = c(0, 5), cex = .4, col = rgb(0, 0, 0, .3))
m <- base::ncol(deseq$raw_mirna_smrnaseq_data)
p <- 3
graphics::abline(h = qf(.99, p, m - p))
```

```{r, eval = config$mirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (excerpt)")
```

```{r, eval = config$mirna_excerpt, out.width = "100%"}
# plot
data <- deseq_results_1$raw_mirna_excerpt_data
W <- data$stat
maxCooks <- base::apply(SummarizedExperiment::assays(deseq$raw_mirna_excerpt_data)[["cooks"]], 1, base::max)
idx <- !is.na(W)
base::plot(rank(W[idx]), maxCooks[idx], xlab = "rank of Wald statistic", 
           ylab = "maximum Cook's distance per RNA",
           ylim = c(0, 5), cex = .4, col = rgb(0, 0, 0, .3))
m <- base::ncol(deseq$raw_mirna_excerpt_data)
p <- 3
graphics::abline(h = qf(.99, p, m - p))
```

```{r, eval = config$pirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### piRNA's (excerpt)")
```

```{r, eval = config$pirna_excerpt, out.width = "100%"}
# plot
data <- deseq_results_1$raw_pirna_excerpt_data
W <- data$stat
maxCooks <- base::apply(SummarizedExperiment::assays(deseq$raw_pirna_excerpt_data)[["cooks"]], 1, base::max)
idx <- !is.na(W)
base::plot(rank(W[idx]), maxCooks[idx], xlab = "rank of Wald statistic", 
           ylab = "maximum Cook's distance per RNA",
           ylim = c(0, 5), cex = .4, col = rgb(0, 0, 0, .3))
m <- base::ncol(deseq$raw_pirna_excerpt_data)
p <- 3
graphics::abline(h = qf(.99, p, m - p))
```

```{r, eval = config$trna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### tRNA's (excerpt)")
```

```{r, eval = config$trna_excerpt, out.width = "100%"}
# plot
data <- deseq_results_1$raw_trna_excerpt_data
W <- data$stat
maxCooks <- base::apply(SummarizedExperiment::assays(deseq$raw_trna_excerpt_data)[["cooks"]], 1, base::max)
idx <- !is.na(W)
base::plot(rank(W[idx]), maxCooks[idx], xlab = "rank of Wald statistic", 
           ylab = "maximum Cook's distance per RNA",
           ylim = c(0, 5), cex = .4, col = rgb(0, 0, 0, .3))
m <- base::ncol(deseq$raw_trna_excerpt_data)
p <- 3
graphics::abline(h = qf(.99, p, m - p))
```

```{r, eval = config$circrna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### circRNA's (excerpt)")
```

```{r, eval = config$circrna_excerpt, out.width = "100%"}
# plot
data <- deseq_results_1$raw_circrna_excerpt_data
W <- data$stat
maxCooks <- base::apply(SummarizedExperiment::assays(deseq$raw_circrna_excerpt_data)[["cooks"]], 1, base::max)
idx <- !is.na(W)
base::plot(rank(W[idx]), maxCooks[idx], xlab = "rank of Wald statistic", 
           ylab = "maximum Cook's distance per RNA",
           ylim = c(0, 5), cex = .4, col = rgb(0, 0, 0, .3))
m <- base::ncol(deseq$raw_circrna_excerpt_data)
p <- 3
graphics::abline(h = qf(.99, p, m - p))
```

```{r, eval = config$gencode_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### gencodes (excerpt)")
```

```{r, eval = config$gencode_excerpt, out.width = "100%"}
# plot
data <- deseq_results_1$raw_gencode_excerpt_data
W <- data$stat
maxCooks <- base::apply(SummarizedExperiment::assays(deseq$raw_gencode_excerpt_data)[["cooks"]], 1, base::max)
idx <- !is.na(W)
base::plot(rank(W[idx]), maxCooks[idx], xlab = "rank of Wald statistic", 
           ylab = "maximum Cook's distance per RNA",
           ylim = c(0, 5), cex = .4, col = rgb(0, 0, 0, .3))
m <- base::ncol(deseq$raw_gencode_excerpt_data)
p <- 3
graphics::abline(h = qf(.99, p, m - p))
```

```{r, eval = contrasts[1]}
# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames) (loop over all datasets)
deseq_results_1 <- base::lapply(deseq_results_1, function(x) {
  
  x %>%
    base::as.data.frame() %>%
    tibble::rownames_to_column("rna") 
  
})

# collapse into one dataframe
deseq_results_1 <- do.call(rbind, deseq_results_1)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
deseq_results_1 <- deseq_results_1 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("\\..*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("(raw_)|(_excerpt_data)|(_smrnaseq_data)", "", source)) %>%
  dplyr::mutate(pipeline = gsub("(raw_mirna_)|(raw_pirna_)|(raw_trna_)|(raw_circrna_)|(raw_gencode_)|(_data)", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[1]) %>%
  dplyr::mutate(diff_expr_method = "DESeq2") %>%
  select(-source)

# rename columns before join
deseq_results_1 <- deseq_results_1 %>%
  dplyr::rename(p_value = pvalue) %>%
  dplyr::rename(adj_p_value = padj) %>%
  dplyr::rename(log_fc = log2FoldChange)
```

```{r, eval = contrasts[2]}
# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames) (loop over all datasets)
deseq_results_2 <- base::lapply(deseq_results_2, function(x) {
  
  x %>%
    base::as.data.frame() %>%
    tibble::rownames_to_column("rna") 
  
})

# collapse into one dataframe
deseq_results_2 <- do.call(rbind, deseq_results_2)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
deseq_results_2 <- deseq_results_2 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("\\..*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("(raw_)|(_excerpt_data)|(_smrnaseq_data)", "", source)) %>%
  dplyr::mutate(pipeline = gsub("(raw_mirna_)|(raw_pirna_)|(raw_trna_)|(raw_circrna_)|(raw_gencode_)|(_data)", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[2]) %>%
  dplyr::mutate(diff_expr_method = "DESeq2") %>%
  select(-source)

# rename columns before join
deseq_results_2 <- deseq_results_2 %>%
  dplyr::rename(p_value = pvalue) %>%
  dplyr::rename(adj_p_value = padj) %>%
  dplyr::rename(log_fc = log2FoldChange)
```

```{r, eval = contrasts[3]}
# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames) (loop over all datasets)
deseq_results_3 <- base::lapply(deseq_results_3, function(x) {
  
  x %>%
    base::as.data.frame() %>%
    tibble::rownames_to_column("rna") 
  
})

# collapse into one dataframe
deseq_results_3 <- do.call(rbind, deseq_results_3)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
deseq_results_3 <- deseq_results_3 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("\\..*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("(raw_)|(_excerpt_data)|(_smrnaseq_data)", "", source)) %>%
  dplyr::mutate(pipeline = gsub("(raw_mirna_)|(raw_pirna_)|(raw_trna_)|(raw_circrna_)|(raw_gencode_)|(_data)", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[3]) %>%
  dplyr::mutate(diff_expr_method = "DESeq2") %>%
  select(-source)

# rename columns before join
deseq_results_3 <- deseq_results_3 %>%
  dplyr::rename(p_value = pvalue) %>%
  dplyr::rename(adj_p_value = padj) %>%
  dplyr::rename(log_fc = log2FoldChange)
```

```{r, eval = contrasts[4]}
# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames) (loop over all datasets)
deseq_results_4 <- base::lapply(deseq_results_4, function(x) {
  
  x %>%
    base::as.data.frame() %>%
    tibble::rownames_to_column("rna") 
  
})

# collapse into one dataframe
deseq_results_4 <- do.call(rbind, deseq_results_4)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
deseq_results_4 <- deseq_results_4 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("\\..*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("(raw_)|(_excerpt_data)|(_smrnaseq_data)", "", source)) %>%
  dplyr::mutate(pipeline = gsub("(raw_mirna_)|(raw_pirna_)|(raw_trna_)|(raw_circrna_)|(raw_gencode_)|(_data)", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[4]) %>%
  dplyr::mutate(diff_expr_method = "DESeq2") %>%
  select(-source)

# rename columns before join
deseq_results_4 <- deseq_results_4 %>%
  dplyr::rename(p_value = pvalue) %>%
  dplyr::rename(adj_p_value = padj) %>%
  dplyr::rename(log_fc = log2FoldChange)
```

```{r, eval = contrasts[5]}
# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames) (loop over all datasets)
deseq_results_5 <- base::lapply(deseq_results_5, function(x) {
  
  x %>%
    base::as.data.frame() %>%
    tibble::rownames_to_column("rna") 
  
})

# collapse into one dataframe
deseq_results_5 <- do.call(rbind, deseq_results_5)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
deseq_results_5 <- deseq_results_5 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("\\..*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("(raw_)|(_excerpt_data)|(_smrnaseq_data)", "", source)) %>%
  dplyr::mutate(pipeline = gsub("(raw_mirna_)|(raw_pirna_)|(raw_trna_)|(raw_circrna_)|(raw_gencode_)|(_data)", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[5]) %>%
  dplyr::mutate(diff_expr_method = "DESeq2") %>%
  select(-source)

# rename columns before join
deseq_results_5 <- deseq_results_5 %>%
  dplyr::rename(p_value = pvalue) %>%
  dplyr::rename(adj_p_value = padj) %>%
  dplyr::rename(log_fc = log2FoldChange)
```

```{r, eval = contrasts[6]}
# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames) (loop over all datasets)
deseq_results_6 <- base::lapply(deseq_results_6, function(x) {
  
  x %>%
    base::as.data.frame() %>%
    tibble::rownames_to_column("rna") 
  
})

# collapse into one dataframe
deseq_results_6 <- do.call(rbind, deseq_results_6)

# define which pipeline, differential expression method, rna species and comparison/contrast that was used (info stored in rownames)
deseq_results_6 <- deseq_results_6 %>%
  tibble::rownames_to_column("source") %>%
  dplyr::mutate(source = gsub("\\..*", "", source)) %>%
  dplyr::mutate(rna_species = gsub("(raw_)|(_excerpt_data)|(_smrnaseq_data)", "", source)) %>%
  dplyr::mutate(pipeline = gsub("(raw_mirna_)|(raw_pirna_)|(raw_trna_)|(raw_circrna_)|(raw_gencode_)|(_data)", "", source)) %>%
  dplyr::mutate(comparison = config$contrasts[6]) %>%
  dplyr::mutate(diff_expr_method = "DESeq2") %>%
  select(-source)

# rename columns before join
deseq_results_6 <- deseq_results_6 %>%
  dplyr::rename(p_value = pvalue) %>%
  dplyr::rename(adj_p_value = padj) %>%
  dplyr::rename(log_fc = log2FoldChange)
```

```{r}
# make a list of all the differential expression results objects in the global environment
deseq_diff_expr_results <- base::do.call("list", base::mget(base::grep("deseq_results_", base::names(.GlobalEnv), value=TRUE)))

# collapse all the differential expression resultsresults from all the contrasts analysed
deseq_diff_expr_results  <- base::do.call(rbind, deseq_diff_expr_results)

# create a column that defines if an RNA is significant or not (at three significance levels and based on
# both limma/voom and deseq results). I ordered the case_when conditions from not significant to significant
# at the 1% level. This way, if an observation is true in several of these case_when categories, it'll be 
# marked with the smallest p-value category is fits into, sort of "rounded up" to the smallest p-value,
# because this case_when function seems to overwrite a value if it falls in a later case_when category
# This data will be used as a "flag" (using highlighting) in the downstream app to indicate a possibly
# significantly differentiated RNA the user of the app might want to investigate
deseq_diff_expr_results <- deseq_diff_expr_results %>%
  dplyr::mutate(significance = dplyr::case_when(adj_p_value > 0.10 ~ "greater_than_10%",
                                                (adj_p_value > 0.05) & (adj_p_value <= 0.10) ~ "significant_10%",
                                                (adj_p_value > 0.01) & (adj_p_value <= 0.05) ~ "significant_5%",
                                                (adj_p_value <= 0.01) ~ "significant_1%"))
```

### MA plots {.tabset .tabset-fade}

```{r, results = "asis"}
base::cat("These plots plot the log2 fold changes versus the mean of normalized counts. These can be used to visualize the differences between treatment group comparisons. In general we would expect the expression of RNA's to remain consistent between treatment groups and so the MA plot should be similar to the shape of a trumpet with most points residing on a y intercept of 0. Differentially expressed RNA's are marked blue.")
```

```{r, results = "asis"}
base::cat(base::paste0("RNA's with a **p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc, " are plotted here."))
```

<div class="alert alert-custom-blue">

```{r, results = "asis"}
base::cat(base::paste0("Blue: RNA's with an **adjusted p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-red">

```{r, results = "asis"}
base::cat(base::paste0("Red: RNA's with an **adjusted p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-yellow">

```{r, results = "asis"}
base::cat(base::paste0("Yellow: RNA's with an **adjusted p-value** smaller than 0.05 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-green">

```{r, results = "asis"}
base::cat(base::paste0("Green: RNA's with an **adjusted p-value** smaller than 0.01 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

```{r, eval = contrasts_chunk_eval$contrast_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[1]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[1]]) & (pipeline == "smrnaseq")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[2]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[2]]) & (pipeline == "smrnaseq")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[3]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[3]]) & (pipeline == "smrnaseq")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[4]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[4]]) & (pipeline == "smrnaseq")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[5]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[5]]) & (pipeline == "smrnaseq")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[6]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[6]]) & (pipeline == "smrnaseq")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  MA_interactive()
```

### Volcano plots {.tabset .tabset-fade}

```{r, results = "asis"}
base::cat("These plots plot the negative log of the p-value against the log fold change")
```

```{r, results = "asis"}
base::cat(base::paste0("RNA's with a **p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc, " are plotted here."))
```

<div class="alert alert-custom-blue">

```{r, results = "asis"}
base::cat(base::paste0("Blue: RNA's with an **adjusted p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-red">

```{r, results = "asis"}
base::cat(base::paste0("Red: RNA's with an **adjusted p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-yellow">

```{r, results = "asis"}
base::cat(base::paste0("Yellow: RNA's with an **adjusted p-value** smaller than 0.05 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

<div class="alert alert-custom-green">

```{r, results = "asis"}
base::cat(base::paste0("Green: RNA's with an **adjusted p-value** smaller than 0.01 and a log fold change greater/smaller than +-", config$min_lfc))
```

</div>

```{r, eval = contrasts_chunk_eval$contrast_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[1]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[1]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_1, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_1, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[1]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[2]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[2]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_2, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_2, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[2]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[3]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[3]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_3, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_3, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[3]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[4]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[4]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_4, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_4, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[4]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[5]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[5]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_5, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_5, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[5]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = contrasts_chunk_eval$contrast_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("####", config$contrasts[[6]], "{.tabset .tabset-fade}")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (smrnaseq)")
```

```{r, eval = to_eval_chunk$mirna_smrnaseq_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[6]]) & (pipeline == "smrnaseq")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$mirna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### miRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$mirna_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "mirna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$pirna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### piRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$pirna_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "pirna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$trna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### tRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$trna_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "trna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$circrna_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### circRNA's (excerpt)")
```

```{r, eval = to_eval_chunk$circrna_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "circrna") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

```{r, eval = to_eval_chunk$gencode_excerpt_6, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("##### gencodes (excerpt)")
```

```{r, eval = to_eval_chunk$gencode_excerpt_6, out.width = "100%"}
deseq_diff_expr_results %>%
  dplyr::filter((rna_species == "gencode") & (comparison == config$contrasts[[6]]) & (pipeline == "excerpt")) %>%
  volcano_interactive()
```

### Results

```{r, results = "asis"}
base::cat(base::paste0("RNA's with a **p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc, " for the [deseq2](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0550-8) differential expression method are reported here."))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_1%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.01"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_5%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.05"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_10%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.10"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'greater_than_10%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.10"))
```

```{r, out.width = "100%"}
# create datatable to explore the data
DT::datatable(deseq_diff_expr_results %>%
                dplyr::filter(p_value <= 0.1) %>%
                dplyr::select(rna,
                              rna_species,
                              pipeline,
                              diff_expr_method,
                              comparison,
                              log_fc,
                              p_value,
                              adj_p_value,
                              significance) %>%
                dplyr::mutate(across(c(rna_species,
                                       pipeline,
                                       diff_expr_method,
                                       comparison,
                                       significance), base::as.factor)) %>%
                dplyr::mutate(across(c(log_fc,
                                       p_value,
                                       adj_p_value), base::as.double)) %>%
                dplyr::mutate(across(c(p_value,
                                       adj_p_value), ~base::round(.x, digits = 10))) %>%
                dplyr::mutate(across(c(log_fc), ~base::round(.x, digits = 4))),
              filter = "top",
              rownames = FALSE,
              colnames = c("RNA",
                           "RNA species",
                           "Pipeline",
                           "Differential expression method",
                           "Comparison",
                           "Log fold change",
                           "p-value",
                           "Adjusted p-value",
                           "Significance"),
              extensions = base::list("ColReorder" = NULL,
                                      "Buttons" = NULL,
                                      "FixedColumns" = base::list(leftColumns=1)),
              options = list(
                dom = "BRrltpi",
                autoWidth = TRUE,
                buttons =
                  list("copy",
                       list(extend = "collection",
                            buttons = c("csv", "excel", "pdf"),
                            text = "Download"),
                       I("colvis"))))
```

```{r}
# write differential expression results to file
deseq_diff_expr_results %>%
  utils::write.table(file = "./diff_expr_results/deseq_diff_expr_results.tsv", row.names=FALSE, sep="\t")
```

## All differential expression results

```{r, eval = contrasts[1]}
# collapse results from deseq and limma/voom differential expression analysis together
diff_expr_results_1 <- dplyr::full_join(limma_voom_results_1, deseq_results_1, by = c("rna", "p_value", "adj_p_value", "log_fc", "rna_species", "pipeline", "comparison", "diff_expr_method"))
```

```{r, eval = contrasts[2]}
# collapse results from deseq and limma/voom differential expression analysis together
diff_expr_results_2 <- dplyr::full_join(limma_voom_results_2, deseq_results_2, by = c("rna", "p_value", "adj_p_value", "log_fc", "rna_species", "pipeline", "comparison", "diff_expr_method"))
```

```{r, eval = contrasts[3]}
# collapse results from deseq and limma/voom differential expression analysis together
diff_expr_results_3 <- dplyr::full_join(limma_voom_results_3, deseq_results_3, by = c("rna", "p_value", "adj_p_value", "log_fc", "rna_species", "pipeline", "comparison", "diff_expr_method"))
```

```{r, eval = contrasts[4]}
# collapse results from deseq and limma/voom differential expression analysis together
diff_expr_results_4 <- dplyr::full_join(limma_voom_results_4, deseq_results_4, by = c("rna", "p_value", "adj_p_value", "log_fc", "rna_species", "pipeline", "comparison", "diff_expr_method"))
```

```{r, eval = contrasts[5]}
# collapse results from deseq and limma/voom differential expression analysis together
diff_expr_results_5 <- dplyr::full_join(limma_voom_results_5, deseq_results_5, by = c("rna", "p_value", "adj_p_value", "log_fc", "rna_species", "pipeline", "comparison", "diff_expr_method"))
```

```{r, eval = contrasts[6]}
# collapse results from deseq and limma/voom differential expression analysis together
diff_expr_results_6 <- dplyr::full_join(limma_voom_results_6, deseq_results_6, by = c("rna", "p_value", "adj_p_value", "log_fc", "rna_species", "pipeline", "comparison", "diff_expr_method"))
```

```{r, results = "asis"}
base::cat(base::paste0("RNA's with a **p-value** smaller than 0.1 and a log fold change greater/smaller than +-", config$min_lfc, " for both the [limma/voom](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2014-15-2-r29) and the [deseq2](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0550-8) differential expression method are reported here."))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_1%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.01"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_5%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.05"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'significant_10%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.10"))
```

```{r, results = "asis"}
base::cat(base::paste0(" - 'greater_than_10%' means the RNA meets the logFC threshold and has an **adjusted p-value** smaller than 0.10"))
```

```{r, out.width = "100%"}
# make a list of all the differential expression results objects in the global environment
diff_expr_results <- base::do.call("list", base::mget(base::grep("diff_expr_results_", base::names(.GlobalEnv), value=TRUE)))

# collapse all the differential expression resultsresults from all the contrasts analysed
diff_expr_results  <- base::do.call(rbind, diff_expr_results)

# create a column that defines if an RNA is significant or not (at three significance levels and based on
# both limma/voom and deseq results). I ordered the case_when conditions from not significant to significant
# at the 1% level. This way, if an observation is true in several of these case_when categories, it'll be 
# marked with the smallest p-value category is fits into, sort of "rounded up" to the smallest p-value,
# because this case_when function seems to overwrite a value if it falls in a later case_when category
# This data will be used as a "flag" (using highlighting) in the downstream app to indicate a possibly
# significantly differentiated RNA the user of the app might want to investigate
diff_expr_results <- diff_expr_results %>%
  dplyr::mutate(significance = dplyr::case_when(adj_p_value > 0.10 ~ "greater_than_10%",
                                                (adj_p_value > 0.05) & (adj_p_value <= 0.10) ~ "significant_10%",
                                                (adj_p_value > 0.01) & (adj_p_value <= 0.05) ~ "significant_5%",
                                                (adj_p_value <= 0.01) ~ "significant_1%"))

# create datatable to explore the data
DT::datatable(diff_expr_results %>%
                dplyr::filter(p_value <= 0.1) %>%
                dplyr::select(rna,
                              rna_species,
                              pipeline,
                              diff_expr_method,
                              comparison,
                              log_fc,
                              p_value,
                              adj_p_value,
                              significance) %>%
                dplyr::mutate(across(c(rna_species,
                                       pipeline,
                                       diff_expr_method,
                                       comparison,
                                       significance), base::as.factor)) %>%
                dplyr::mutate(across(c(log_fc,
                                       p_value,
                                       adj_p_value), base::as.double)) %>%
                dplyr::mutate(across(c(p_value,
                                       adj_p_value), ~base::round(.x, digits = 10))) %>%
                dplyr::mutate(across(c(log_fc), ~base::round(.x, digits = 4))),
              filter = "top",
              rownames = FALSE,
              colnames = c("RNA",
                           "RNA species",
                           "Pipeline",
                           "Differential expression method",
                           "Comparison",
                           "Log fold change",
                           "p-value",
                           "Adjusted p-value",
                           "Significance"),
              extensions = base::list("ColReorder" = NULL,
                                      "Buttons" = NULL,
                                      "FixedColumns" = base::list(leftColumns=1)),
              options = list(
                dom = "BRrltpi",
                autoWidth = TRUE,
                buttons =
                  list("copy",
                       list(extend = "collection",
                            buttons = c("csv", "excel", "pdf"),
                            text = "Download"),
                       I("colvis"))))
```

```{r}
# write differential expression results to file
diff_expr_results %>%
  utils::write.table(file = "./diff_expr_results/diff_expr_results.tsv", row.names=FALSE, sep="\t")

# extract a list of the significant genes/transcripts (at three significance levels)
sig_diff_expr_data_1 <- diff_expr_results %>%
  dplyr::filter(significance == "significant_1%") %>%
  dplyr::select(rna) %>%
  dplyr::distinct(rna)

sig_diff_expr_data_5 <- diff_expr_results %>%
  dplyr::filter(significance == "significant_5%") %>%
  dplyr::select(rna) %>%
  dplyr::distinct(rna)

sig_diff_expr_data_10 <- diff_expr_results %>%
  dplyr::filter(significance == "significant_10%") %>%
  dplyr::select(rna) %>%
  dplyr::distinct(rna)

# also write these to file
utils::write.csv(sig_diff_expr_data_1, file = "./diff_expr_results/sig_diff_expr_results_1.csv", row.names = FALSE)
utils::write.csv(sig_diff_expr_data_5, file = "./diff_expr_results/sig_diff_expr_results_5.csv", row.names = FALSE)
utils::write.csv(sig_diff_expr_data_10, file = "./diff_expr_results/sig_diff_expr_results_10.csv", row.names = FALSE)
```

```{r, cleanup, results = "hide"}
# clean up
rm(list = ls())
```
