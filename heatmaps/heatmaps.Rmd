---
title: "Heatmaps"
author:
  # - Jane Doe^[Institution Two, jane@example.org]      # add report authors (uncomment if using)
  # - John Doe^[Institution One, john@example.org]      # add a second report author (uncomment if using)
date: "Date: `r base::format(Sys.time(), '%d/%m/%Y')`"
always_allow_html: true
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: false
    self_contained: yes
    css: ../esr-styles.css
    highlight: pygments
    includes:
      after_body: ../esr_footer.html
  editor_options: 
    chunk_output_type: console
---

<img src="../images/ESR_logo.svg" style="position:absolute;top:19px;right:40px;width:23%;" />

```{r setup, include=FALSE}
# setup default chunk settings
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.align = "center")
```

## Info

General info:

- *Colour ranges are relative within each RNA species*
- *Only the RNA's that were found to be significantly differentially expressed by at least one differential expression method are plotted here*

```{r, results = FALSE}
# load libraries
library(dplyr)
library(plotly)
library(gtools)
library(DT)
library(heatmaply)
library(edgeR)
library(textshape)

# for icons at bottom of doc
htmltools::tagList(rmarkdown::html_dependency_font_awesome())

# read in pre-prepared count data
counts <- utils::read.csv("../prepare_counts/counts.csv")

# read in yaml config file
config <- yaml::yaml.load_file("../config/config.yaml")

# read in metadata
metadata <- utils::read.csv(file.path(config$metadata))

# read in differential expression results
diff_expr_results <- utils::read.table("../diff_expression/diff_expr_results/diff_expr_results.tsv",
                                       header = TRUE)

# write differential expression results to file
diff_expr_results %>%
  utils::write.table(file = "../diff_expression/diff_expr_results/diff_expr_results.tsv", row.names=FALSE, sep="\t")

# load all the count datasets (premade rds objects)
raw_mirna_smrnaseq_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_mirna_smrnaseq_counts.rds"))
raw_mirna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_mirna_excerpt_counts.rds"))
raw_pirna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_pirna_excerpt_counts.rds"))
raw_trna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_trna_excerpt_counts.rds"))
raw_circrna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_circrna_excerpt_counts.rds"))
raw_gencode_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/raw_gencode_excerpt_counts.rds"))

lcpm_mirna_smrnaseq_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/lcpm_mirna_smrnaseq_counts.rds"))
lcpm_mirna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/lcpm_mirna_excerpt_counts.rds"))
lcpm_pirna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/lcpm_pirna_excerpt_counts.rds"))
lcpm_trna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/lcpm_trna_excerpt_counts.rds"))
lcpm_circrna_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/lcpm_circrna_excerpt_counts.rds"))
lcpm_gencode_excerpt_data <- base::readRDS(base::file.path(config$template_dir, "prepare_counts/rds_objects/lcpm_gencode_excerpt_counts.rds"))

# create a vector defining the count datasets to analyse (that are set to TRUE) based on the yaml user configuration file
to_analyse <- config[c("mirna_smrnaseq",
                       "mirna_excerpt",
                       "pirna_excerpt",
                       "trna_excerpt",
                       "circrna_excerpt",
                       "gencode_excerpt")] %>%
  base::as.data.frame() %>%
  base::t() %>%
  base::as.data.frame() %>%
  tibble::rownames_to_column("rna_species") %>%
  dplyr::rename("analyse" = "V1") %>%
  tidyr::separate(rna_species, c("rna_species", "pipeline")) %>%
  dplyr::filter(analyse == TRUE) %>%
  dplyr::mutate(dataset_name = base::paste0(rna_species, "_", pipeline)) %>%
  dplyr::pull(dataset_name)

# define which datasets/rna species were actually analysed in the differential expression analysis
# to be used to flag the difference between "no significantly differentially expressed RNA's found"
# and "RNA not analysed in differential expression anaysis
diff_expr_analysed <- diff_expr_results %>%
  dplyr::mutate(dataset = paste(rna_species, pipeline, sep = "_"))

diff_expr_analysed <- unique(diff_expr_analysed$dataset)

# set up a vector of all the possible datasets to analyse
raw_datasets  <- base::list(mirna_smrnaseq = raw_mirna_smrnaseq_data,
                            mirna_excerpt = raw_mirna_excerpt_data,
                            pirna_excerpt = raw_pirna_excerpt_data,
                            trna_excerpt = raw_trna_excerpt_data,
                            circrna_excerpt = raw_circrna_excerpt_data,
                            gencode_excerpt = raw_gencode_excerpt_data)

lcpm_datasets  <- base::list(mirna_smrnaseq = lcpm_mirna_smrnaseq_data,
                             mirna_excerpt = lcpm_mirna_excerpt_data,
                             pirna_excerpt = lcpm_pirna_excerpt_data,
                             trna_excerpt = lcpm_trna_excerpt_data,
                             circrna_excerpt = lcpm_circrna_excerpt_data,
                             gencode_excerpt = lcpm_gencode_excerpt_data)

# filter all possible datasets by the datasets the user has specified to analyse
raw_datasets <- raw_datasets[to_analyse]
lcpm_datasets <- lcpm_datasets[to_analyse]

# get a list of RNA's that were found to be significantly differentially expressed by at least one differential expression method
sig_rnas <- diff_expr_results %>%
  dplyr::filter(significance %in% c("significant_1%", "significant_5%", "significant_10%"))

# extract significant rna data into separate dataframes
sig_mirna_smrnaseq <- sig_rnas %>%
  dplyr::filter(pipeline == "smrnaseq") %>%
  dplyr::filter(rna_species == "mirna")

sig_mirna_excerpt <- sig_rnas %>%
  dplyr::filter(pipeline == "excerpt") %>%
  dplyr::filter(rna_species == "mirna")

sig_pirna_excerpt <- sig_rnas %>%
  dplyr::filter(pipeline == "excerpt") %>%
  dplyr::filter(rna_species == "pirna")

sig_trna_excerpt <- sig_rnas %>%
  dplyr::filter(pipeline == "excerpt") %>%
  dplyr::filter(rna_species == "trna")

sig_circrna_excerpt <- sig_rnas %>%
  dplyr::filter(pipeline == "excerpt") %>%
  dplyr::filter(rna_species == "circrna")

sig_gencode_excerpt <- sig_rnas %>%
  dplyr::filter(pipeline == "excerpt") %>%
  dplyr::filter(rna_species == "gencode")

# create a true/false strings that defines if there are more than 300 significant genes/transcripts for plotting
too_many_mirna_smrnaseq <- nrow(sig_mirna_smrnaseq) > 300
too_many_mirna_excerpt <- nrow(sig_mirna_excerpt) > 300
too_many_pirna_excerpt <- nrow(sig_pirna_excerpt) > 300
too_many_trna_excerpt <- nrow(sig_trna_excerpt) > 300
too_many_circrna_excerpt <- nrow(sig_circrna_excerpt) > 300
too_many_gencode_excerpt <- nrow(sig_gencode_excerpt) > 300

# if there ARE too many significant RNA's (more than 300)
# subset to 300 with the greatest log fold change
# if the AREN'T too many significant RNA's, just pull the RNA list
if(too_many_mirna_smrnaseq == TRUE) {
  
  sig_mirna_smrnaseq <- sig_mirna_smrnaseq %>%
    # make a column with all log fold change values as positive values
    dplyr::mutate(log_fc_all_positive = base::abs(log_fc)) %>%
    # arrange by the largest log fold change (irrespective if it's positive or negative)
    dplyr::arrange(plyr::desc(log_fc_all_positive)) %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
  # get top 300 RNA's
  sig_mirna_smrnaseq <- sig_mirna_smrnaseq[1:300]
  
} else if(too_many_mirna_smrnaseq == FALSE) {
  
  sig_mirna_smrnaseq <- sig_mirna_smrnaseq %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
}

if(too_many_mirna_excerpt == TRUE) {
  
  sig_mirna_excerpt <- sig_mirna_excerpt %>%
    # make a column with all log fold change values as positive values
    dplyr::mutate(log_fc_all_positive = base::abs(log_fc)) %>%
    # arrange by the largest log fold change (irrespective if it's positive or negative)
    dplyr::arrange(plyr::desc(log_fc_all_positive)) %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
  # get top 300 RNA's
  sig_mirna_excerpt <- sig_mirna_excerpt[1:300]
  
} else if(too_many_mirna_excerpt == FALSE) {
  
  sig_mirna_excerpt <- sig_mirna_excerpt %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
}

if(too_many_pirna_excerpt == TRUE) {
  
  sig_pirna_excerpt <- sig_pirna_excerpt %>%
    # make a column with all log fold change values as positive values
    dplyr::mutate(log_fc_all_positive = base::abs(log_fc)) %>%
    # arrange by the largest log fold change (irrespective if it's positive or negative)
    dplyr::arrange(plyr::desc(log_fc_all_positive)) %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
  # get top 300 RNA's
  sig_pirna_excerpt <- sig_pirna_excerpt[1:300]
  
} else if(too_many_pirna_excerpt == FALSE) {
  
  sig_pirna_excerpt <- sig_pirna_excerpt %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
}

if(too_many_trna_excerpt == TRUE) {
  
  sig_trna_excerpt <- sig_trna_excerpt %>%
    # make a column with all log fold change values as positive values
    dplyr::mutate(log_fc_all_positive = base::abs(log_fc)) %>%
    # arrange by the largest log fold change (irrespective if it's positive or negative)
    dplyr::arrange(plyr::desc(log_fc_all_positive)) %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
  # get top 300 RNA's
  sig_trna_excerpt <- sig_trna_excerpt[1:300]
  
} else if(too_many_trna_excerpt == FALSE) {
  
  sig_trna_excerpt <- sig_trna_excerpt %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
}

if(too_many_circrna_excerpt == TRUE) {
  
  sig_circrna_excerpt <- sig_circrna_excerpt %>%
    # make a column with all log fold change values as positive values
    dplyr::mutate(log_fc_all_positive = base::abs(log_fc)) %>%
    # arrange by the largest log fold change (irrespective if it's positive or negative)
    dplyr::arrange(plyr::desc(log_fc_all_positive)) %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
  # get top 300 RNA's
  sig_circrna_excerpt <- sig_circrna_excerpt[1:300]
  
} else if(too_many_circrna_excerpt == FALSE) {
  
  sig_circrna_excerpt <- sig_circrna_excerpt %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
}

if(too_many_gencode_excerpt == TRUE) {
  
  sig_gencode_excerpt <- sig_gencode_excerpt %>%
    # make a column with all log fold change values as positive values
    dplyr::mutate(log_fc_all_positive = base::abs(log_fc)) %>%
    # arrange by the largest log fold change (irrespective if it's positive or negative)
    dplyr::arrange(plyr::desc(log_fc_all_positive)) %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
  # get top 300 RNA's
  sig_gencode_excerpt <- sig_gencode_excerpt[1:300]
  
} else if(too_many_gencode_excerpt == FALSE) {
  
  sig_gencode_excerpt <- sig_gencode_excerpt %>%
    # get the RNA names
    dplyr::pull(rna) %>%
    # get the unique RNA's (since there can be multiple rows for a given gene)
    base::unique()
  
}

# merge RNA lists back together
sig_rnas <- c(sig_mirna_smrnaseq,
              sig_mirna_excerpt,
              sig_pirna_excerpt,
              sig_trna_excerpt,
              sig_circrna_excerpt,
              sig_gencode_excerpt)

# get the significantly differentially expressed RNA's (loop over all count datasets)
log_counts_per_million <- base::lapply(lcpm_datasets, function(x)
  
  x %>%
    base::as.data.frame() %>%
    tibble::rownames_to_column("rna") %>%
    dplyr::filter(rna %in% sig_rnas) %>%
    textshape::column_to_rownames("rna")
  
)

# make sure the samples (columns) in all the datasets are in the same order for specifying the treatments downstream
# (that depends on the columns being in the correct order)
log_counts_per_million <- base::lapply(log_counts_per_million, function(x)
  
  x %>%
    dplyr::arrange(desc(rowSums(x)))
  
)

# sort columns
log_counts_per_million <- base::lapply(log_counts_per_million, function(x)
  
  x[ , gtools::mixedsort(names(x))] %>%
    base::as.matrix()
  
)

# setup a string that scales the widths of the subplots for each heatmap based on the number of treatment groups
all_widths <- metadata %>%
  group_by(treatment) %>%
  dplyr::summarise(n_samples = n()) %>%
  dplyr::mutate(n_samples = n_samples/base::length(metadata$treatment)) %>%
  dplyr::pull(n_samples)

# set heatmap figure heights to automatically scale to how many rows are present in the data
fig_height_mirna_smrnaseq <- base::nrow(log_counts_per_million$mirna_smrnaseq) / 6
fig_height_mirna_excerpt <- base::nrow(log_counts_per_million$mirna_excerpt) / 6
fig_height_pirna_excerpt <- base::nrow(log_counts_per_million$pirna_excerpt) / 6
fig_height_trna_excerpt <- base::nrow(log_counts_per_million$trna_excerpt) / 6
fig_height_circrna_excerpt <- base::nrow(log_counts_per_million$circrna_excerpt) / 6
fig_height_gencode_excerpt <- base::nrow(log_counts_per_million$gencode_excerpt) / 6

fig_height_mirna_smrnaseq_free <- base::nrow(log_counts_per_million$mirna_smrnaseq) / 4
fig_height_mirna_excerpt_free <- base::nrow(log_counts_per_million$mirna_excerpt) / 4
fig_height_pirna_excerpt_free <- base::nrow(log_counts_per_million$pirna_excerpt) / 4
fig_height_trna_excerpt_free <- base::nrow(log_counts_per_million$trna_excerpt) / 4
fig_height_circrna_excerpt_free <- base::nrow(log_counts_per_million$circrna_excerpt) / 4
fig_height_gencode_excerpt_free <- base::nrow(log_counts_per_million$gencode_excerpt) / 4

# need to set the figure height to NOT ZERO when the figure height ends up being less than 1 so rmarkdown doesn't error out on knitting
fig_height_mirna_smrnaseq[fig_height_mirna_smrnaseq <1 ] <- 1
fig_height_mirna_excerpt[fig_height_mirna_excerpt <1 ] <- 1
fig_height_pirna_excerpt[fig_height_pirna_excerpt <1 ] <- 1
fig_height_trna_excerpt[fig_height_trna_excerpt <1 ] <- 1
fig_height_circrna_excerpt[fig_height_circrna_excerpt <1 ] <- 1
fig_height_gencode_excerpt[fig_height_gencode_excerpt <1 ] <- 1

fig_height_mirna_smrnaseq_free[fig_height_mirna_smrnaseq_free <1 ] <- 1
fig_height_mirna_excerpt_free[fig_height_mirna_excerpt_free <1 ] <- 1
fig_height_pirna_excerpt_free[fig_height_pirna_excerpt_free <1 ] <- 1
fig_height_trna_excerpt_free[fig_height_trna_excerpt_free <1 ] <- 1
fig_height_circrna_excerpt_free[fig_height_circrna_excerpt_free <1 ] <- 1
fig_height_gencode_excerpt_free[fig_height_gencode_excerpt_free <1 ] <- 1

# also need to set the figure height to NOT ZERO when there are no rows of data so rmarkdown doesn't error out on knitting
fig_height_mirna_smrnaseq[is.na(fig_height_mirna_smrnaseq[1])] <- 1
fig_height_mirna_excerpt[is.na(fig_height_mirna_excerpt[1])] <- 1
fig_height_pirna_excerpt[is.na(fig_height_pirna_excerpt[1])] <- 1
fig_height_trna_excerpt[is.na(fig_height_trna_excerpt[1])] <- 1
fig_height_circrna_excerpt[is.na(fig_height_circrna_excerpt[1])] <- 1
fig_height_gencode_excerpt[is.na(fig_height_gencode_excerpt[1])] <- 1

fig_height_mirna_smrnaseq_free[is.na(fig_height_mirna_smrnaseq_free[1])] <- 1
fig_height_mirna_excerpt_free[is.na(fig_height_mirna_excerpt_free[1])] <- 1
fig_height_pirna_excerpt_free[is.na(fig_height_pirna_excerpt_free[1])] <- 1
fig_height_trna_excerpt_free[is.na(fig_height_trna_excerpt_free[1])] <- 1
fig_height_circrna_excerpt_free[is.na(fig_height_circrna_excerpt_free[1])] <- 1
fig_height_gencode_excerpt_free[is.na(fig_height_gencode_excerpt_free[1])] <- 1

# specify treatments by creating a string of conditions that match the order of the columns/samples in the count data
# get the treatments and samples names from the metadata file
treatments <- metadata %>%
  dplyr::select(sample, treatment)

# also sort by the sample column (important so it matches the order of the samples count datasets)
# this is critical for DESeq2 - it assumes they are in the same order
treatments$sample <- gtools::mixedsort(treatments$sample)

# extract only the conditions/groups and create a list out of it
ordered_treatments <- treatments %>%
  dplyr::pull(treatment)
```

Datasets analysed:

```{r, results = "asis"}
# print the datasets the user has chosen to analyse for this document
base::cat(base::paste0(" - mirna smrnaseq: ", config$mirna_smrnaseq, "\n",
                       " - mirna excerpt: ", config$mirna_excerpt, "\n",
                       " - pirna excerpt: ", config$pirna_excerpt, "\n",
                       " - trna excerpt: ", config$trna_excerpt, "\n",
                       " - circrna excerpt: ", config$circrna_excerpt, "\n",
                       " - gencode excerpt: ", config$gencode_excerpt, "\n"))
```

Treatment comparisons: 

```{r, results = "asis"}
# print the treatment group comparisons the user has chosen to analyse
base::cat(base::paste0("- ", config$contrasts, "\n"))
```

```{r, results = "asis"}
# print the number of samples analysed
base::cat(base::paste0("Total number of samples: ", length(unique(metadata$sample))))
```

Number of samples in each treatment group:

```{r, results = "asis"}
# print the number of samples in each treatment group
n_samples_by_treatment <- metadata %>%
  group_by(treatment) %>%
  dplyr::summarise(n_samples = n())

base::cat(base::paste0("- ", n_samples_by_treatment$treatment, ": ", n_samples_by_treatment$n_samples, "\n"))
```

## Heatmap {.tabset .tabset-fade}

### By treatment group {.tabset .tabset-fade}

```{r, eval = config$mirna_smrnaseq, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (smrnaseq)")
```

```{r, eval = too_many_mirna_smrnaseq, results = "asis"}
base::cat(base::paste0("Too many significant miRNA's to plot. Plotting only 300 miRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$mirna_smrnaseq, fig.height = fig_height_mirna_smrnaseq, out.width = "100%"}
# extract datasets
lcpm_mirna_smrnaseq <- log_counts_per_million$mirna_smrnaseq

# setup for heatmap plotting
# get the number of unique treatments
N <- base::nlevels(base::factor(metadata$treatment))

# set up an empty list of dataframes that define which samples exist in which treatment group
data_subset_list <- base::vector("list", N)

# set up an empty list of dataframes for the plotting data
data_list <- base::vector("list", N)

# set up an empty list for the plots
plot_list <- base::vector("list", N)

# get the max RNA count in all datasets (over all mirnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_mirna_smrnaseq))

# get the min RNA count in all datasets (over all mirnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_mirna_smrnaseq))

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_mirna_smrnaseq)) == FALSE & nrow(lcpm_mirna_smrnaseq) > 3 & "mirna_smrnaseq" %in% diff_expr_analysed == TRUE) {
  
  # loop plotting over all treatment levels
  for (i in 1:N) {
    
    # make a variable that defines the current treatment/level we're dealing with in the for loop
    current_treatment <- mixedsort(levels(factor(metadata$treatment)))[i]
    
    # get the samples in each treatment
    data_subset_list[[i]] <- metadata %>%
      filter(treatment == current_treatment) %>%
      select(sample)
    
    # set up the data
    # populate the list of dataframes with data
    data_list[[i]] <- lcpm_mirna_smrnaseq %>%
      base::as.data.frame() %>%
      # select the samples from each treatment group based on "data_subset_list"
      dplyr::select(data_subset_list[[i]] %>% dplyr::pull(sample)) %>%
      # prepare data for plotting with matrix
      base::as.matrix()
    
    # create custom text that will be appended to the tooltip
    custom_tooltip <- base::matrix(base::paste("Treatment:", current_treatment,
                                               "\nPipeline: smrnaseq"
    ),
    # make it the same dimensions as the current dataset (required for this to work)
    nrow = base::nrow(data_list[[i]]),
    ncol = base::ncol(data_list[[i]]))
    
    # plot a heatmap for each treatment
    p <- data_list[[i]] %>%
      heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                           xlab = paste(current_treatment),
                           dendrogram = c("none"),
                           key.title = "Log counts \n per million",
                           label_names = c("RNA", "Sample", "Log counts per million"),
                           label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                           custom_hovertext = custom_tooltip,
                           showticklabels = c(FALSE, TRUE),
                           titleX = FALSE,
                           srtCol = 45,
                           hide_colorbar = TRUE)
    
    plot_list[[i]] = p
    
  }
  
  # plot all together
  plotly::subplot(plot_list, nrows = 1, margin = .002, shareY = TRUE, shareX = TRUE, titleX = TRUE, widths = c(all_widths))
  
} else if (all(is.na(lcpm_mirna_smrnaseq)) == FALSE & nrow(lcpm_mirna_smrnaseq) <= 3 & "mirna_smrnaseq" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed miRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_mirna_smrnaseq)) == TRUE & "mirna_smrnaseq" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed miRNA's"))
} else if (all(is.na(lcpm_mirna_smrnaseq)) == TRUE & "mirna_smrnaseq" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$mirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (excerpt)")
```

```{r, eval = too_many_mirna_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant miRNA's to plot. Plotting only 300 miRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$mirna_excerpt, fig.height = fig_height_mirna_excerpt, out.width = "100%"}
# extract datasets
lcpm_mirna_excerpt <- log_counts_per_million$mirna_excerpt

# setup for heatmap plotting
# get the number of unique treatments
N <- base::nlevels(base::factor(metadata$treatment))

# set up an empty list of dataframes that define which samples exist in which treatment group
data_subset_list <- base::vector("list", N)

# set up an empty list of dataframes for the plotting data
data_list <- base::vector("list", N)

# set up an empty list for the plots
plot_list <- base::vector("list", N)

# get the max RNA count in all datasets (over all mirnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_mirna_excerpt))

# get the min RNA count in all datasets (over all mirnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_mirna_excerpt))

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_mirna_excerpt)) == FALSE & nrow(lcpm_mirna_excerpt) > 3 & "mirna_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # loop plotting over all treatment levels
  for (i in 1:N) {
    
    # make a variable that defines the current treatment/level we're dealing with in the for loop
    current_treatment <- mixedsort(levels(factor(metadata$treatment)))[i]
    
    # get the samples in each treatment
    data_subset_list[[i]] <- metadata %>%
      filter(treatment == current_treatment) %>%
      select(sample)
    
    # set up the data
    # populate the list of dataframes with data
    data_list[[i]] <- lcpm_mirna_excerpt %>%
      base::as.data.frame() %>%
      # select the samples from each treatment group based on "data_subset_list"
      dplyr::select(data_subset_list[[i]] %>% dplyr::pull(sample)) %>%
      # prepare data for plotting with matrix
      base::as.matrix()
    
    # create custom text that will be appended to the tooltip
    custom_tooltip <- base::matrix(base::paste("Treatment:", current_treatment,
                                               "\nPipeline: excerpt"
    ),
    # make it the same dimensions as the current dataset (required for this to work)
    nrow = base::nrow(data_list[[i]]),
    ncol = base::ncol(data_list[[i]]))
    
    # plot a heatmap for each treatment
    p <- data_list[[i]] %>%
      heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                           xlab = paste(current_treatment),
                           dendrogram = c("none"),
                           key.title = "Log counts \n per million",
                           label_names = c("RNA", "Sample", "Log counts per million"),
                           label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                           custom_hovertext = custom_tooltip,
                           showticklabels = c(FALSE, TRUE),
                           titleX = FALSE,
                           srtCol = 45,
                           hide_colorbar = TRUE)
    
    plot_list[[i]] = p
    
  }
  
  # plot all together
  plotly::subplot(plot_list, nrows = 1, margin = .002, shareY = TRUE, shareX = TRUE, titleX = TRUE, widths = c(all_widths))
  
} else if (all(is.na(lcpm_mirna_excerpt)) == FALSE & nrow(lcpm_mirna_excerpt) <= 3 & "mirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed miRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_mirna_excerpt)) == TRUE & "mirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed miRNA's"))
} else if (all(is.na(lcpm_mirna_excerpt)) == TRUE & "mirna_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$pirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### piRNA's (excerpt)")
```

```{r, eval = too_many_pirna_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant piRNA's to plot. Plotting only 300 piRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$pirna_excerpt, fig.height = fig_height_pirna_excerpt, out.width = "100%"}
# extract datasets
lcpm_pirna_excerpt <- log_counts_per_million$pirna_excerpt

# setup for heatmap plotting
# get the number of unique treatments
N <- base::nlevels(base::factor(metadata$treatment))

# set up an empty list of dataframes that define which samples exist in which treatment group
data_subset_list <- base::vector("list", N)

# set up an empty list of dataframes for the plotting data
data_list <- base::vector("list", N)

# set up an empty list for the plots
plot_list <- base::vector("list", N)

# get the max RNA count in all datasets (over all pirnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_pirna_excerpt))

# get the min RNA count in all datasets (over all pirnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_pirna_excerpt))

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_pirna_excerpt)) == FALSE & nrow(lcpm_pirna_excerpt) > 3 & "pirna_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # loop plotting over all treatment levels
  for (i in 1:N) {
    
    # make a variable that defines the current treatment/level we're dealing with in the for loop
    current_treatment <- mixedsort(levels(factor(metadata$treatment)))[i]
    
    # get the samples in each treatment
    data_subset_list[[i]] <- metadata %>%
      filter(treatment == current_treatment) %>%
      select(sample)
    
    # set up the data
    # populate the list of dataframes with data
    data_list[[i]] <- lcpm_pirna_excerpt %>%
      base::as.data.frame() %>%
      # select the samples from each treatment group based on "data_subset_list"
      dplyr::select(data_subset_list[[i]] %>% dplyr::pull(sample)) %>%
      # prepare data for plotting with matrix
      base::as.matrix()
    
    # create custom text that will be appended to the tooltip
    custom_tooltip <- base::matrix(base::paste("Treatment:", current_treatment,
                                               "\nPipeline: excerpt"
    ),
    # make it the same dimensions as the current dataset (required for this to work)
    nrow = base::nrow(data_list[[i]]),
    ncol = base::ncol(data_list[[i]]))
    
    # plot a heatmap for each treatment
    p <- data_list[[i]] %>%
      heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                           xlab = paste(current_treatment),
                           dendrogram = c("none"),
                           key.title = "Log counts \n per million",
                           label_names = c("RNA", "Sample", "Log counts per million"),
                           label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                           custom_hovertext = custom_tooltip,
                           showticklabels = c(FALSE, TRUE),
                           titleX = FALSE,
                           srtCol = 45,
                           hide_colorbar = TRUE)
    
    plot_list[[i]] = p
    
  }
  
  # plot all together
  plotly::subplot(plot_list, nrows = 1, margin = .002, shareY = TRUE, shareX = TRUE, titleX = TRUE, widths = c(all_widths))
  
} else if (all(is.na(lcpm_pirna_excerpt)) == FALSE & nrow(lcpm_pirna_excerpt) <= 3 & "pirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed piRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_pirna_excerpt)) == TRUE & "pirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed piRNA's"))
} else if (all(is.na(lcpm_pirna_excerpt)) == TRUE & "pirna_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$trna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### tRNA's (excerpt)")
```

```{r, eval = too_many_trna_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant tRNA's to plot. Plotting only 300 tRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$trna_excerpt, fig.height = fig_height_trna_excerpt, out.width = "100%"}
# extract datasets
lcpm_trna_excerpt <- log_counts_per_million$trna_excerpt

# setup for heatmap plotting
# get the number of unique treatments
N <- base::nlevels(base::factor(metadata$treatment))

# set up an empty list of dataframes that define which samples exist in which treatment group
data_subset_list <- base::vector("list", N)

# set up an empty list of dataframes for the plotting data
data_list <- base::vector("list", N)

# set up an empty list for the plots
plot_list <- base::vector("list", N)

# get the max RNA count in all datasets (over all trnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_trna_excerpt))

# get the min RNA count in all datasets (over all trnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_trna_excerpt))

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_trna_excerpt)) == FALSE & nrow(lcpm_trna_excerpt) > 3 & "trna_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # loop plotting over all treatment levels
  for (i in 1:N) {
    
    # make a variable that defines the current treatment/level we're dealing with in the for loop
    current_treatment <- mixedsort(levels(factor(metadata$treatment)))[i]
    
    # get the samples in each treatment
    data_subset_list[[i]] <- metadata %>%
      filter(treatment == current_treatment) %>%
      select(sample)
    
    # set up the data
    # populate the list of dataframes with data
    data_list[[i]] <- lcpm_trna_excerpt %>%
      base::as.data.frame() %>%
      # select the samples from each treatment group based on "data_subset_list"
      dplyr::select(data_subset_list[[i]] %>% dplyr::pull(sample)) %>%
      # prepare data for plotting with matrix
      base::as.matrix()
    
    # create custom text that will be appended to the tooltip
    custom_tooltip <- base::matrix(base::paste("Treatment:", current_treatment,
                                               "\nPipeline: excerpt"
    ),
    # make it the same dimensions as the current dataset (required for this to work)
    nrow = base::nrow(data_list[[i]]),
    ncol = base::ncol(data_list[[i]]))
    
    # plot a heatmap for each treatment
    p <- data_list[[i]] %>%
      heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                           xlab = paste(current_treatment),
                           dendrogram = c("none"),
                           key.title = "Log counts \n per million",
                           label_names = c("RNA", "Sample", "Log counts per million"),
                           label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                           custom_hovertext = custom_tooltip,
                           showticklabels = c(FALSE, TRUE),
                           titleX = FALSE,
                           srtCol = 45,
                           hide_colorbar = TRUE)
    
    plot_list[[i]] = p
    
  }
  
  # plot all together
  plotly::subplot(plot_list, nrows = 1, margin = .002, shareY = TRUE, shareX = TRUE, titleX = TRUE, widths = c(all_widths))
  
} else if (all(is.na(lcpm_trna_excerpt)) == FALSE & nrow(lcpm_trna_excerpt) <= 3 & "trna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed tRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_trna_excerpt)) == TRUE & "trna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed tRNA's"))
} else if (all(is.na(lcpm_trna_excerpt)) == TRUE & "trna_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$circrna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### circRNA's (excerpt)")
```

```{r, eval = too_many_circrna_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant circRNA's to plot. Plotting only 300 circRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$circrna_excerpt, fig.height = fig_height_circrna_excerpt, out.width = "100%"}
# extract datasets
lcpm_circrna_excerpt <- log_counts_per_million$circrna_excerpt

# setup for heatmap plotting
# get the number of unique treatments
N <- base::nlevels(base::factor(metadata$treatment))

# set up an empty list of dataframes that define which samples exist in which treatment group
data_subset_list <- base::vector("list", N)

# set up an empty list of dataframes for the plotting data
data_list <- base::vector("list", N)

# set up an empty list for the plots
plot_list <- base::vector("list", N)

# get the max RNA count in all datasets (over all circrnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_circrna_excerpt))

# get the min RNA count in all datasets (over all circrnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_circrna_excerpt))

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_circrna_excerpt)) == FALSE & nrow(lcpm_circrna_excerpt) > 3 & "circrna_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # loop plotting over all treatment levels
  for (i in 1:N) {
    
    # make a variable that defines the current treatment/level we're dealing with in the for loop
    current_treatment <- mixedsort(levels(factor(metadata$treatment)))[i]
    
    # get the samples in each treatment
    data_subset_list[[i]] <- metadata %>%
      filter(treatment == current_treatment) %>%
      select(sample)
    
    # set up the data
    # populate the list of dataframes with data
    data_list[[i]] <- lcpm_circrna_excerpt %>%
      base::as.data.frame() %>%
      # select the samples from each treatment group based on "data_subset_list"
      dplyr::select(data_subset_list[[i]] %>% dplyr::pull(sample)) %>%
      # prepare data for plotting with matrix
      base::as.matrix()
    
    # create custom text that will be appended to the tooltip
    custom_tooltip <- base::matrix(base::paste("Treatment:", current_treatment,
                                               "\nPipeline: excerpt"
    ),
    # make it the same dimensions as the current dataset (required for this to work)
    nrow = base::nrow(data_list[[i]]),
    ncol = base::ncol(data_list[[i]]))
    
    # plot a heatmap for each treatment
    p <- data_list[[i]] %>%
      heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                           xlab = paste(current_treatment),
                           dendrogram = c("none"),
                           key.title = "Log counts \n per million",
                           label_names = c("RNA", "Sample", "Log counts per million"),
                           label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                           custom_hovertext = custom_tooltip,
                           showticklabels = c(FALSE, TRUE),
                           titleX = FALSE,
                           srtCol = 45,
                           hide_colorbar = TRUE)
    
    plot_list[[i]] = p
    
  }
  
  # plot all together
  plotly::subplot(plot_list, nrows = 1, margin = .002, shareY = TRUE, shareX = TRUE, titleX = TRUE, widths = c(all_widths))
  
} else if (all(is.na(lcpm_circrna_excerpt)) == FALSE & nrow(lcpm_circrna_excerpt) <= 3 & "circrna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed circRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_circrna_excerpt)) == TRUE & "circrna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed circRNA's"))
} else if (all(is.na(lcpm_circrna_excerpt)) == TRUE & "circrna_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$gencode_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### gencode's (excerpt)")
```

```{r, eval = too_many_gencode_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant gencode's to plot. Plotting only 300 gencode's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$gencode_excerpt, fig.height = fig_height_gencode_excerpt, out.width = "100%"}
# extract datasets
lcpm_gencode_excerpt <- log_counts_per_million$gencode_excerpt

# setup for heatmap plotting
# get the number of unique treatments
N <- base::nlevels(base::factor(metadata$treatment))

# set up an empty list of dataframes that define which samples exist in which treatment group
data_subset_list <- base::vector("list", N)

# set up an empty list of dataframes for the plotting data
data_list <- base::vector("list", N)

# set up an empty list for the plots
plot_list <- base::vector("list", N)

# get the max RNA count in all datasets (over all gencodes) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_gencode_excerpt))

# get the min RNA count in all datasets (over all gencodes) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_gencode_excerpt))

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_gencode_excerpt)) == FALSE & nrow(lcpm_gencode_excerpt) > 3 & "gencode_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # loop plotting over all treatment levels
  for (i in 1:N) {
    
    # make a variable that defines the current treatment/level we're dealing with in the for loop
    current_treatment <- mixedsort(levels(factor(metadata$treatment)))[i]
    
    # get the samples in each treatment
    data_subset_list[[i]] <- metadata %>%
      filter(treatment == current_treatment) %>%
      select(sample)
    
    # set up the data
    # populate the list of dataframes with data
    data_list[[i]] <- lcpm_gencode_excerpt %>%
      base::as.data.frame() %>%
      # select the samples from each treatment group based on "data_subset_list"
      dplyr::select(data_subset_list[[i]] %>% dplyr::pull(sample)) %>%
      # prepare data for plotting with matrix
      base::as.matrix()
    
    # create custom text that will be appended to the tooltip
    custom_tooltip <- base::matrix(base::paste("Treatment:", current_treatment,
                                               "\nPipeline: excerpt"
    ),
    # make it the same dimensions as the current dataset (required for this to work)
    nrow = base::nrow(data_list[[i]]),
    ncol = base::ncol(data_list[[i]]))
    
    # plot a heatmap for each treatment
    p <- data_list[[i]] %>%
      heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                           xlab = paste(current_treatment),
                           dendrogram = c("none"),
                           key.title = "Log counts \n per million",
                           label_names = c("RNA", "Sample", "Log counts per million"),
                           label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                           custom_hovertext = custom_tooltip,
                           showticklabels = c(FALSE, TRUE),
                           titleX = FALSE,
                           srtCol = 45,
                           hide_colorbar = TRUE)
    
    plot_list[[i]] = p
    
  }
  
  # plot all together
  plotly::subplot(plot_list, nrows = 1, margin = .002, shareY = TRUE, shareX = TRUE, titleX = TRUE, widths = c(all_widths))
  
} else if (all(is.na(lcpm_gencode_excerpt)) == FALSE & nrow(lcpm_gencode_excerpt) <= 3 & "gencode_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed gencode's to cluster in a PCA"))
} else if (all(is.na(lcpm_gencode_excerpt)) == TRUE & "gencode_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed gencode's"))
} else if (all(is.na(lcpm_gencode_excerpt)) == TRUE & "gencode_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

### Free to cluster {.tabset .tabset-fade}

```{r, eval = config$mirna_smrnaseq, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (smrnaseq)")
```

```{r, eval = too_many_mirna_smrnaseq, results = "asis"}
base::cat(base::paste0("Too many significant miRNA's to plot. Plotting only 300 miRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$mirna_smrnaseq, fig.height = fig_height_mirna_smrnaseq_free, out.width = "100%"}
# extract datasets
lcpm_mirna_smrnaseq <- log_counts_per_million$mirna_smrnaseq

# get the max RNA count in all datasets (over all mirnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_mirna_smrnaseq))

# get the min RNA count in all datasets (over all mirnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_mirna_smrnaseq))

# create custom text that will be appended to the tooltip
custom_tooltip <- base::matrix(base::paste("Treatment: ", rep(ordered_treatments, times = nrow(lcpm_mirna_smrnaseq)),
                                           "\nPipeline: smrnaseq"),
                               nrow = length(unique(metadata$sample)),
                               ncol = nrow(lcpm_mirna_smrnaseq)) %>%
  t()

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_mirna_smrnaseq)) == FALSE & nrow(lcpm_mirna_smrnaseq) > 3 & "mirna_smrnaseq" %in% diff_expr_analysed == TRUE) {
  
  # plot a heatmap for each treatment
  lcpm_mirna_smrnaseq %>%
    heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                         xlab = "Sample",
                         dendrogram = c("both"),
                         key.title = "Log counts \n per million",
                         label_names = c("RNA", "Sample", "Log counts per million"),
                         label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                         custom_hovertext = custom_tooltip,
                         showticklabels = c(FALSE, TRUE),
                         titleX = FALSE,
                         srtCol = 45,
                         seriate = "mean",
                         col_side_colors = ordered_treatments,
                         hide_colorbar = TRUE)
  
} else if (all(is.na(lcpm_mirna_smrnaseq)) == FALSE & nrow(lcpm_mirna_smrnaseq) <= 3 & "mirna_smrnaseq" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed miRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_mirna_smrnaseq)) == TRUE & "mirna_smrnaseq" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed miRNA's"))
} else if (all(is.na(lcpm_mirna_smrnaseq)) == TRUE & "mirna_smrnaseq" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$mirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### miRNA's (excerpt)")
```

```{r, eval = too_many_mirna_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant miRNA's to plot. Plotting only 300 miRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$mirna_excerpt, fig.height = fig_height_mirna_excerpt_free, out.width = "100%"}
# extract datasets
lcpm_mirna_excerpt <- log_counts_per_million$mirna_excerpt

# get the max RNA count in all datasets (over all mirnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_mirna_excerpt))

# get the min RNA count in all datasets (over all mirnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_mirna_excerpt))

# create custom text that will be appended to the tooltip
custom_tooltip <- base::matrix(base::paste("Treatment: ", rep(ordered_treatments, times = nrow(lcpm_mirna_excerpt)),
                                           "\nPipeline: excerpt"),
                               nrow = length(unique(metadata$sample)),
                               ncol = nrow(lcpm_mirna_excerpt)) %>%
  t()

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_mirna_excerpt)) == FALSE & nrow(lcpm_mirna_excerpt) > 3 & "mirna_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # plot a heatmap for each treatment
  lcpm_mirna_excerpt %>%
    heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                         xlab = "Sample",
                         dendrogram = c("both"),
                         key.title = "Log counts \n per million",
                         label_names = c("RNA", "Sample", "Log counts per million"),
                         label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                         custom_hovertext = custom_tooltip,
                         showticklabels = c(FALSE, TRUE),
                         titleX = FALSE,
                         srtCol = 45,
                         seriate = "mean",
                         col_side_colors = ordered_treatments,
                         hide_colorbar = TRUE)
  
} else if (all(is.na(lcpm_mirna_excerpt)) == FALSE & nrow(lcpm_mirna_smrnaseq) <= 3 & "mirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed miRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_mirna_excerpt)) == TRUE & "mirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed miRNA's"))
} else if (all(is.na(lcpm_mirna_excerpt)) == TRUE & "mirna_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$pirna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### piRNA's (excerpt)")
```

```{r, eval = too_many_pirna_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant piRNA's to plot. Plotting only 300 piRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$pirna_excerpt, fig.height = fig_height_pirna_excerpt_free, out.width = "100%"}
# extract datasets
lcpm_pirna_excerpt <- log_counts_per_million$pirna_excerpt

# get the max RNA count in all datasets (over all pirnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_pirna_excerpt))

# get the min RNA count in all datasets (over all pirnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_pirna_excerpt))

# create custom text that will be appended to the tooltip
custom_tooltip <- base::matrix(base::paste("Treatment: ", rep(ordered_treatments, times = nrow(lcpm_pirna_excerpt)),
                                           "\nPipeline: excerpt"),
                               nrow = length(unique(metadata$sample)),
                               ncol = nrow(lcpm_pirna_excerpt)) %>%
  t()

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_pirna_excerpt)) == FALSE & nrow(lcpm_pirna_excerpt) > 3 & "pirna_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # plot a heatmap for each treatment
  lcpm_pirna_excerpt %>%
    heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                         xlab = "Sample",
                         dendrogram = c("both"),
                         key.title = "Log counts \n per million",
                         label_names = c("RNA", "Sample", "Log counts per million"),
                         label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                         custom_hovertext = custom_tooltip,
                         showticklabels = c(FALSE, TRUE),
                         titleX = FALSE,
                         srtCol = 45,
                         seriate = "mean",
                         col_side_colors = ordered_treatments,
                         hide_colorbar = TRUE)
  
} else if (all(is.na(lcpm_pirna_excerpt)) == FALSE & nrow(lcpm_pirna_excerpt) <= 3 & "pirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed piRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_pirna_excerpt)) == TRUE & "pirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed piRNA's"))
} else if (all(is.na(lcpm_pirna_excerpt)) == TRUE & "pirna_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$trna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### tRNA's (excerpt)")
```

```{r, eval = too_many_trna_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant tRNA's to plot. Plotting only 300 tRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$trna_excerpt, fig.height = fig_height_trna_excerpt_free, out.width = "100%"}
# extract datasets
lcpm_trna_excerpt <- log_counts_per_million$trna_excerpt

# get the max RNA count in all datasets (over all trnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_trna_excerpt))

# get the min RNA count in all datasets (over all trnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_trna_excerpt))

# create custom text that will be appended to the tooltip
custom_tooltip <- base::matrix(base::paste("Treatment: ", rep(ordered_treatments, times = nrow(lcpm_trna_excerpt)),
                                           "\nPipeline: excerpt"),
                               nrow = length(unique(metadata$sample)),
                               ncol = nrow(lcpm_trna_excerpt)) %>%
  t()

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_trna_excerpt)) == FALSE & nrow(lcpm_trna_excerpt) > 3 & "trna_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # plot a heatmap for each treatment
  lcpm_trna_excerpt %>%
    heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                         xlab = "Sample",
                         dendrogram = c("both"),
                         key.title = "Log counts \n per million",
                         label_names = c("RNA", "Sample", "Log counts per million"),
                         label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                         custom_hovertext = custom_tooltip,
                         showticklabels = c(FALSE, TRUE),
                         titleX = FALSE,
                         srtCol = 45,
                         seriate = "mean",
                         col_side_colors = ordered_treatments,
                         hide_colorbar = TRUE)
  
} else if (all(is.na(lcpm_trna_excerpt)) == FALSE & nrow(lcpm_trna_excerpt) <= 3 & "mirna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed tRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_trna_excerpt)) == TRUE & "trna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed tRNA's"))
} else if (all(is.na(lcpm_trna_excerpt)) == TRUE & "trna_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$circrna_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### circRNA's (excerpt)")
```

```{r, eval = too_many_circrna_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant circRNA's to plot. Plotting only 300 circRNA's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$circrna_excerpt, fig.height = fig_height_circrna_excerpt_free, out.width = "100%"}
# extract datasets
lcpm_circrna_excerpt <- log_counts_per_million$circrna_excerpt

# get the max RNA count in all datasets (over all circrnas) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_circrna_excerpt))

# get the min RNA count in all datasets (over all circrnas) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_circrna_excerpt))

# create custom text that will be appended to the tooltip
custom_tooltip <- base::matrix(base::paste("Treatment: ", rep(ordered_treatments, times = nrow(lcpm_circrna_excerpt)),
                                           "\nPipeline: excerpt"),
                               nrow = length(unique(metadata$sample)),
                               ncol = nrow(lcpm_circrna_excerpt)) %>%
  t()

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_circrna_excerpt)) == FALSE & nrow(lcpm_circrna_excerpt) > 3 & "circrna_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # plot a heatmap for each treatment
  lcpm_circrna_excerpt %>%
    heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                         xlab = "Sample",
                         dendrogram = c("both"),
                         key.title = "Log counts \n per million",
                         label_names = c("RNA", "Sample", "Log counts per million"),
                         label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                         custom_hovertext = custom_tooltip,
                         showticklabels = c(FALSE, TRUE),
                         titleX = FALSE,
                         srtCol = 45,
                         seriate = "mean",
                         col_side_colors = ordered_treatments,
                         hide_colorbar = TRUE)
  
} else if (all(is.na(lcpm_circrna_excerpt)) == FALSE & nrow(lcpm_circrna_excerpt) <= 3 & "circrna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed circRNA's to cluster in a PCA"))
} else if (all(is.na(lcpm_circrna_excerpt)) == TRUE & "circrna_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed circRNA's"))
} else if (all(is.na(lcpm_circrna_excerpt)) == TRUE & "circrna_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, eval = config$gencode_excerpt, results = "asis"}
# optionally include/print markdown header for this section if being analysed
base::cat("#### gencode's (excerpt)")
```

```{r, eval = too_many_gencode_excerpt, results = "asis"}
base::cat(base::paste0("Too many significant gencode's to plot. Plotting only 300 gencode's with the largest log fold change among all treatment comparisons."))
```

```{r, eval = config$gencode_excerpt, fig.height = fig_height_gencode_excerpt_free, out.width = "100%"}
# extract datasets
lcpm_gencode_excerpt <- log_counts_per_million$gencode_excerpt

# get the max RNA count in all datasets (over all gencodes) to scale the colour scale to
maximum_rna_count <- base::max(c(lcpm_gencode_excerpt))

# get the min RNA count in all datasets (over all gencodes) to scale the colour scale to
minimum_rna_count <- base::min(c(lcpm_gencode_excerpt))

# create custom text that will be appended to the tooltip
custom_tooltip <- base::matrix(base::paste("Treatment: ", rep(ordered_treatments, times = nrow(lcpm_gencode_excerpt)),
                                           "\nPipeline: excerpt"),
                               nrow = length(unique(metadata$sample)),
                               ncol = nrow(lcpm_gencode_excerpt)) %>%
  t()

# set up the colour gradient palette
gradient_col <- ggplot2::scale_fill_gradient2(
  low = "#0097db",
  mid = "white",
  high = "#ec1515",
  midpoint = maximum_rna_count/1.5,
  limits = c(minimum_rna_count, maximum_rna_count))

# check if the matrix for plotting is empty after filtering for only significantly differentially expressed RNA's
# if there ARE significantly differentially expressed RNA's (and there are more than two of them), create a heatmap
# if there AREN'T significantly differentially expressed RNA's, print a message saying so
# if the dataset wasn't analysed, print a message saying so
if (all(is.na(lcpm_gencode_excerpt)) == FALSE & nrow(lcpm_gencode_excerpt) > 3 & "gencode_excerpt" %in% diff_expr_analysed == TRUE) {
  
  # plot a heatmap for each treatment
  lcpm_gencode_excerpt %>%
    heatmaply::heatmaply(scale_fill_gradient_fun = gradient_col,
                         xlab = "Sample",
                         dendrogram = c("both"),
                         key.title = "Log counts \n per million",
                         label_names = c("RNA", "Sample", "Log counts per million"),
                         label_format_fun = function(...) format(..., big.mark = ",", scientific = FALSE, digits = 0),
                         custom_hovertext = custom_tooltip,
                         showticklabels = c(FALSE, TRUE),
                         titleX = FALSE,
                         srtCol = 45,
                         seriate = "mean",
                         col_side_colors = ordered_treatments,
                         hide_colorbar = TRUE)
  
} else if (all(is.na(lcpm_gencode_excerpt)) == FALSE & nrow(lcpm_gencode_excerpt) <= 3 & "gencode_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("Too few significantly differentially expressed gencode's to cluster in a PCA"))
} else if (all(is.na(lcpm_gencode_excerpt)) == TRUE & "gencode_excerpt" %in% diff_expr_analysed == TRUE) {
  cat(paste("No significantly differentially expressed gencode's"))
} else if (all(is.na(lcpm_gencode_excerpt)) == TRUE & "gencode_excerpt" %in% diff_expr_analysed == FALSE) {
  cat(paste("Dataset not analysed"))
}
```

```{r, cleanup, results = "hide"}
# clean up
rm(list = ls())
```
